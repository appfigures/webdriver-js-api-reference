<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="COMM">// Copyright 2011 Software Freedom Conservancy. All Rights Reserved.</span><span class="WHIT">
<span class='line'>  2</span> </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>  3</span> </span><span class="COMM">// Licensed under the Apache License, Version 2.0 (the "License");</span><span class="WHIT">
<span class='line'>  4</span> </span><span class="COMM">// you may not use this file except in compliance with the License.</span><span class="WHIT">
<span class='line'>  5</span> </span><span class="COMM">// You may obtain a copy of the License at</span><span class="WHIT">
<span class='line'>  6</span> </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>  7</span> </span><span class="COMM">//      http://www.apache.org/licenses/LICENSE-2.0</span><span class="WHIT">
<span class='line'>  8</span> </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>  9</span> </span><span class="COMM">// Unless required by applicable law or agreed to in writing, software</span><span class="WHIT">
<span class='line'> 10</span> </span><span class="COMM">// distributed under the License is distributed on an "AS IS" BASIS,</span><span class="WHIT">
<span class='line'> 11</span> </span><span class="COMM">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span class="WHIT">
<span class='line'> 12</span> </span><span class="COMM">// See the License for the specific language governing permissions and</span><span class="WHIT">
<span class='line'> 13</span> </span><span class="COMM">// limitations under the License.</span><span class="WHIT">
<span class='line'> 14</span> 
<span class='line'> 15</span> </span><span class="COMM">/**
<span class='line'> 16</span>  * @license Portions of this code are from the Dojo toolkit, received under the
<span class='line'> 17</span>  * BSD License:
<span class='line'> 18</span>  * Redistribution and use in source and binary forms, with or without
<span class='line'> 19</span>  * modification, are permitted provided that the following conditions are met:
<span class='line'> 20</span>  *
<span class='line'> 21</span>  *   * Redistributions of source code must retain the above copyright notice,
<span class='line'> 22</span>  *     this list of conditions and the following disclaimer.
<span class='line'> 23</span>  *   * Redistributions in binary form must reproduce the above copyright notice,
<span class='line'> 24</span>  *     this list of conditions and the following disclaimer in the documentation
<span class='line'> 25</span>  *     and/or other materials provided with the distribution.
<span class='line'> 26</span>  *   * Neither the name of the Dojo Foundation nor the names of its contributors
<span class='line'> 27</span>  *     may be used to endorse or promote products derived from this software
<span class='line'> 28</span>  *     without specific prior written permission.
<span class='line'> 29</span>  *
<span class='line'> 30</span>  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
<span class='line'> 31</span>  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
<span class='line'> 32</span>  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
<span class='line'> 33</span>  * ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
<span class='line'> 34</span>  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
<span class='line'> 35</span>  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
<span class='line'> 36</span>  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
<span class='line'> 37</span>  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
<span class='line'> 38</span>  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
<span class='line'> 39</span>  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
<span class='line'> 40</span>  * POSSIBILITY OF SUCH DAMAGE.
<span class='line'> 41</span>  */</span><span class="WHIT">
<span class='line'> 42</span> 
<span class='line'> 43</span> </span><span class="COMM">/**
<span class='line'> 44</span>  * @fileoverview A promise implementation based on the CommonJS promise/A and
<span class='line'> 45</span>  * promise/B proposals. For more information, see
<span class='line'> 46</span>  * http://wiki.commonjs.org/wiki/Promises.
<span class='line'> 47</span>  */</span><span class="WHIT">
<span class='line'> 48</span> 
<span class='line'> 49</span> </span><span class="NAME">goog.provide</span><span class="PUNC">(</span><span class="STRN">'webdriver.promise'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 50</span> </span><span class="NAME">goog.provide</span><span class="PUNC">(</span><span class="STRN">'webdriver.promise.ControlFlow'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 51</span> </span><span class="NAME">goog.provide</span><span class="PUNC">(</span><span class="STRN">'webdriver.promise.ControlFlow.Timer'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 52</span> </span><span class="NAME">goog.provide</span><span class="PUNC">(</span><span class="STRN">'webdriver.promise.Deferred'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 53</span> </span><span class="NAME">goog.provide</span><span class="PUNC">(</span><span class="STRN">'webdriver.promise.Promise'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 54</span> 
<span class='line'> 55</span> </span><span class="NAME">goog.require</span><span class="PUNC">(</span><span class="STRN">'goog.array'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 56</span> </span><span class="NAME">goog.require</span><span class="PUNC">(</span><span class="STRN">'goog.debug.Error'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 57</span> </span><span class="NAME">goog.require</span><span class="PUNC">(</span><span class="STRN">'goog.object'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 58</span> </span><span class="NAME">goog.require</span><span class="PUNC">(</span><span class="STRN">'webdriver.EventEmitter'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 59</span> </span><span class="NAME">goog.require</span><span class="PUNC">(</span><span class="STRN">'webdriver.stacktrace.Snapshot'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 60</span> 
<span class='line'> 61</span> 
<span class='line'> 62</span> 
<span class='line'> 63</span> </span><span class="COMM">/**
<span class='line'> 64</span>  * Represents the eventual value of a completed operation. Each promise may be
<span class='line'> 65</span>  * in one of three states: pending, resolved, or rejected. Each promise starts
<span class='line'> 66</span>  * in the pending state and may make a single transition to either a
<span class='line'> 67</span>  * fulfilled or failed state.
<span class='line'> 68</span>  *
<span class='line'> 69</span>  * &lt;p/>This class is based on the Promise/A proposal from CommonJS. Additional
<span class='line'> 70</span>  * functions are provided for API compatibility with Dojo Deferred objects.
<span class='line'> 71</span>  *
<span class='line'> 72</span>  * @constructor
<span class='line'> 73</span>  * @see http://wiki.commonjs.org/wiki/Promises/A
<span class='line'> 74</span>  */</span><span class="WHIT">
<span class='line'> 75</span> </span><span class="NAME">webdriver.promise.Promise</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 76</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 77</span> 
<span class='line'> 78</span> 
<span class='line'> 79</span> </span><span class="COMM">/**
<span class='line'> 80</span>  * Cancels the computation of this promise's value, rejecting the promise in the
<span class='line'> 81</span>  * process.
<span class='line'> 82</span>  * @param {*} reason The reason this promise is being cancelled. If not an
<span class='line'> 83</span>  *     {@code Error}, one will be created using the value's string
<span class='line'> 84</span>  *     representation.
<span class='line'> 85</span>  */</span><span class="WHIT">
<span class='line'> 86</span> </span><span class="NAME">webdriver.promise.Promise.prototype.cancel</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">reason</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 87</span> </span><span class="WHIT">  </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">TypeError</span><span class="PUNC">(</span><span class="STRN">'Unimplemented function: "cancel"'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 88</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 89</span> 
<span class='line'> 90</span> 
<span class='line'> 91</span> </span><span class="COMM">/** @return {boolean} Whether this promise's value is still being computed. */</span><span class="WHIT">
<span class='line'> 92</span> </span><span class="NAME">webdriver.promise.Promise.prototype.isPending</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 93</span> </span><span class="WHIT">  </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">TypeError</span><span class="PUNC">(</span><span class="STRN">'Unimplemented function: "isPending"'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 94</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 95</span> 
<span class='line'> 96</span> 
<span class='line'> 97</span> </span><span class="COMM">/**
<span class='line'> 98</span>  * Registers listeners for when this instance is resolved. This function most
<span class='line'> 99</span>  * overridden by subtypes.
<span class='line'>100</span>  *
<span class='line'>101</span>  * @param {Function=} opt_callback The function to call if this promise is
<span class='line'>102</span>  *     successfully resolved. The function should expect a single argument: the
<span class='line'>103</span>  *     promise's resolved value.
<span class='line'>104</span>  * @param {Function=} opt_errback The function to call if this promise is
<span class='line'>105</span>  *     rejected. The function should expect a single argument: the rejection
<span class='line'>106</span>  *     reason.
<span class='line'>107</span>  * @return {!webdriver.promise.Promise} A new promise which will be resolved
<span class='line'>108</span>  *     with the result of the invoked callback.
<span class='line'>109</span>  */</span><span class="WHIT">
<span class='line'>110</span> </span><span class="NAME">webdriver.promise.Promise.prototype.then</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>111</span> </span><span class="WHIT">    </span><span class="NAME">opt_callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_errback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>112</span> </span><span class="WHIT">  </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">TypeError</span><span class="PUNC">(</span><span class="STRN">'Unimplemented function: "then"'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>113</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>114</span> 
<span class='line'>115</span> 
<span class='line'>116</span> </span><span class="COMM">/**
<span class='line'>117</span>  * Registers a function to be invoked when this promise is successfully
<span class='line'>118</span>  * resolved. This function is provided for backwards compatibility with the
<span class='line'>119</span>  * Dojo Deferred API.
<span class='line'>120</span>  *
<span class='line'>121</span>  * @param {Function} callback The function to call if this promise is
<span class='line'>122</span>  *     successfully resolved. The function should expect a single argument: the
<span class='line'>123</span>  *     promise's resolved value.
<span class='line'>124</span>  * @param {!Object=} opt_self The object which |this| should refer to when the
<span class='line'>125</span>  *     function is invoked.
<span class='line'>126</span>  * @return {!webdriver.promise.Promise} A new promise which will be resolved
<span class='line'>127</span>  *     with the result of the invoked callback.
<span class='line'>128</span>  */</span><span class="WHIT">
<span class='line'>129</span> </span><span class="NAME">webdriver.promise.Promise.prototype.addCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_self</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>130</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.then</span><span class="PUNC">(</span><span class="NAME">goog.bind</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_self</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>131</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>132</span> 
<span class='line'>133</span> 
<span class='line'>134</span> </span><span class="COMM">/**
<span class='line'>135</span>  * Registers a function to be invoked when this promise is rejected.
<span class='line'>136</span>  * This function is provided for backwards compatibility with the
<span class='line'>137</span>  * Dojo Deferred API.
<span class='line'>138</span>  *
<span class='line'>139</span>  * @param {Function} errback The function to call if this promise is
<span class='line'>140</span>  *     rejected. The function should expect a single argument: the rejection
<span class='line'>141</span>  *     reason.
<span class='line'>142</span>  * @param {!Object=} opt_self The object which |this| should refer to when the
<span class='line'>143</span>  *     function is invoked.
<span class='line'>144</span>  * @return {!webdriver.promise.Promise} A new promise which will be resolved
<span class='line'>145</span>  *     with the result of the invoked callback.
<span class='line'>146</span>  */</span><span class="WHIT">
<span class='line'>147</span> </span><span class="NAME">webdriver.promise.Promise.prototype.addErrback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">errback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_self</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>148</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.then</span><span class="PUNC">(</span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">goog.bind</span><span class="PUNC">(</span><span class="NAME">errback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_self</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>149</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>150</span> 
<span class='line'>151</span> 
<span class='line'>152</span> </span><span class="COMM">/**
<span class='line'>153</span>  * Registers a function to be invoked when this promise is either rejected or
<span class='line'>154</span>  * resolved. This function is provided for backwards compatibility with the
<span class='line'>155</span>  * Dojo Deferred API.
<span class='line'>156</span>  *
<span class='line'>157</span>  * @param {Function} callback The function to call when this promise is
<span class='line'>158</span>  *     either resolved or rejected. The function should expect a single
<span class='line'>159</span>  *     argument: the resolved value or rejection error.
<span class='line'>160</span>  * @param {!Object=} opt_self The object which |this| should refer to when the
<span class='line'>161</span>  *     function is invoked.
<span class='line'>162</span>  * @return {!webdriver.promise.Promise} A new promise which will be resolved
<span class='line'>163</span>  *     with the result of the invoked callback.
<span class='line'>164</span>  */</span><span class="WHIT">
<span class='line'>165</span> </span><span class="NAME">webdriver.promise.Promise.prototype.addBoth</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_self</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>166</span> </span><span class="WHIT">  </span><span class="NAME">callback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">goog.bind</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_self</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>167</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.then</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>168</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>169</span> 
<span class='line'>170</span> 
<span class='line'>171</span> </span><span class="COMM">/**
<span class='line'>172</span>  * An alias for {@code webdriver.promise.Promise.prototype.then} that permits
<span class='line'>173</span>  * the scope of the invoked function to be specified. This function is provided
<span class='line'>174</span>  * for backwards compatibility with the Dojo Deferred API.
<span class='line'>175</span>  *
<span class='line'>176</span>  * @param {Function} callback The function to call if this promise is
<span class='line'>177</span>  *     successfully resolved. The function should expect a single argument: the
<span class='line'>178</span>  *     promise's resolved value.
<span class='line'>179</span>  * @param {Function} errback The function to call if this promise is
<span class='line'>180</span>  *     rejected. The function should expect a single argument: the rejection
<span class='line'>181</span>  *     reason.
<span class='line'>182</span>  * @param {!Object=} opt_self The object which |this| should refer to when the
<span class='line'>183</span>  *     function is invoked.
<span class='line'>184</span>  * @return {!webdriver.promise.Promise} A new promise which will be resolved
<span class='line'>185</span>  *     with the result of the invoked callback.
<span class='line'>186</span>  */</span><span class="WHIT">
<span class='line'>187</span> </span><span class="NAME">webdriver.promise.Promise.prototype.addCallbacks</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>188</span> </span><span class="WHIT">    </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_self</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>189</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.then</span><span class="PUNC">(</span><span class="NAME">goog.bind</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_self</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>190</span> </span><span class="WHIT">      </span><span class="NAME">goog.bind</span><span class="PUNC">(</span><span class="NAME">errback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_self</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>191</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>192</span> 
<span class='line'>193</span> 
<span class='line'>194</span> 
<span class='line'>195</span> </span><span class="COMM">/**
<span class='line'>196</span>  * Represents a value that will be resolved at some point in the future. This
<span class='line'>197</span>  * class represents the protected "producer" half of a Promise - each Deferred
<span class='line'>198</span>  * has a {@code promise} property that may be returned to consumers for
<span class='line'>199</span>  * registering callbacks, reserving the ability to resolve the deferred to the
<span class='line'>200</span>  * producer.
<span class='line'>201</span>  *
<span class='line'>202</span>  * &lt;p>If this Deferred is rejected and there are no listeners registered before
<span class='line'>203</span>  * the next turn of the event loop, the rejection will be passed to the
<span class='line'>204</span>  * {@link webdriver.promise.ControlFlow} as an unhandled failure.
<span class='line'>205</span>  *
<span class='line'>206</span>  * &lt;p>If this Deferred is cancelled, the cancellation reason will be forward to
<span class='line'>207</span>  * the Deferred's canceller function (if provided). The canceller may return a
<span class='line'>208</span>  * truth-y value to override the reason provided for rejection.
<span class='line'>209</span>  *
<span class='line'>210</span>  * @param {Function=} opt_canceller Function to call when cancelling the
<span class='line'>211</span>  *     computation of this instance's value.
<span class='line'>212</span>  * @param {webdriver.promise.ControlFlow=} opt_flow The control flow
<span class='line'>213</span>  *     this instance was created under. This should only be provided during
<span class='line'>214</span>  *     unit tests.
<span class='line'>215</span>  * @constructor
<span class='line'>216</span>  * @extends {webdriver.promise.Promise}
<span class='line'>217</span>  */</span><span class="WHIT">
<span class='line'>218</span> </span><span class="NAME">webdriver.promise.Deferred</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">opt_canceller</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_flow</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>219</span> </span><span class="WHIT">  </span><span class="COMM">/* NOTE: This class's implementation diverges from the prototypical style
<span class='line'>220</span>    * used in the rest of the atoms library. This was done intentionally to
<span class='line'>221</span>    * protect the internal Deferred state from consumers, as outlined by
<span class='line'>222</span>    *     http://wiki.commonjs.org/wiki/Promises
<span class='line'>223</span>    */</span><span class="WHIT">
<span class='line'>224</span> </span><span class="WHIT">  </span><span class="NAME">goog.base</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>225</span> 
<span class='line'>226</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">flow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">opt_flow</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.controlFlow</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>227</span> 
<span class='line'>228</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>229</span>    * The listeners registered with this Deferred. Each element in the list will
<span class='line'>230</span>    * be a 3-tuple of the callback function, errback function, and the
<span class='line'>231</span>    * corresponding deferred object.
<span class='line'>232</span>    * @type {!Array.&lt;!webdriver.promise.Deferred.Listener_>}
<span class='line'>233</span>    */</span><span class="WHIT">
<span class='line'>234</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">listeners</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>235</span> 
<span class='line'>236</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>237</span>    * Whether this Deferred's resolution was ever handled by a listener.
<span class='line'>238</span>    * If the Deferred is rejected and its value is not handled by a listener
<span class='line'>239</span>    * before the next turn of the event loop, the error will be passed to the
<span class='line'>240</span>    * global error handler.
<span class='line'>241</span>    * @type {boolean}
<span class='line'>242</span>    */</span><span class="WHIT">
<span class='line'>243</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">handled</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>244</span> 
<span class='line'>245</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>246</span>    * Key for the timeout used to delay reproting an unhandled rejection to the
<span class='line'>247</span>    * parent {@link webdriver.promise.ControlFlow}.
<span class='line'>248</span>    * @type {?number}
<span class='line'>249</span>    */</span><span class="WHIT">
<span class='line'>250</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pendingRejectionKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>251</span> 
<span class='line'>252</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>253</span>    * This Deferred's current state.
<span class='line'>254</span>    * @type {!webdriver.promise.Deferred.State_}
<span class='line'>255</span>    */</span><span class="WHIT">
<span class='line'>256</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">state</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred.State_.PENDING</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>257</span> 
<span class='line'>258</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>259</span>    * This Deferred's resolved value; set when the state transitions from
<span class='line'>260</span>    * {@code webdriver.promise.Deferred.State_.PENDING}.
<span class='line'>261</span>    * @type {*}
<span class='line'>262</span>    */</span><span class="WHIT">
<span class='line'>263</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>264</span> 
<span class='line'>265</span> </span><span class="WHIT">  </span><span class="COMM">/** @return {boolean} Whether this promise's value is still pending. */</span><span class="WHIT">
<span class='line'>266</span> </span><span class="WHIT">  </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">isPending</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>267</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">state</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred.State_.PENDING</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>268</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>269</span> 
<span class='line'>270</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>271</span>    * Removes all of the listeners previously registered on this deferred.
<span class='line'>272</span>    * @throws {Error} If this deferred has already been resolved.
<span class='line'>273</span>    */</span><span class="WHIT">
<span class='line'>274</span> </span><span class="WHIT">  </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">removeAll</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>275</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">isPending</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>276</span> </span><span class="WHIT">      </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">'This Deferred has already been resolved. (1)'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>277</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>278</span> </span><span class="WHIT">    </span><span class="NAME">listeners</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>279</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>280</span> 
<span class='line'>281</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>282</span>    * Notifies all of the listeners registered with this Deferred that its state
<span class='line'>283</span>    * has changed. Will throw an error if this Deferred has already been
<span class='line'>284</span>    * resolved.
<span class='line'>285</span>    * @param {!webdriver.promise.Deferred.State_} newState The deferred's new
<span class='line'>286</span>    *     state.
<span class='line'>287</span>    * @param {*} newValue The deferred's new value.
<span class='line'>288</span>    */</span><span class="WHIT">
<span class='line'>289</span> </span><span class="WHIT">  </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">notifyAll</span><span class="PUNC">(</span><span class="NAME">newState</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newValue</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>290</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">isPending</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>291</span> </span><span class="WHIT">      </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">'This Deferred has already been resolved. (2)'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>292</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>293</span> 
<span class='line'>294</span> </span><span class="WHIT">    </span><span class="NAME">state</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newState</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>295</span> </span><span class="WHIT">    </span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newValue</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>296</span> </span><span class="WHIT">    </span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">listeners.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>297</span> </span><span class="WHIT">      </span><span class="NAME">notify</span><span class="PUNC">(</span><span class="NAME">listeners.shift</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>298</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>299</span> 
<span class='line'>300</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">handled</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">state</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred.State_.REJECTED</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>301</span> </span><span class="WHIT">      </span><span class="NAME">pendingRejectionKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">propagateError</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>302</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>303</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>304</span> 
<span class='line'>305</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>306</span>    * Propagates an unhandled rejection to the parent ControlFlow in a
<span class='line'>307</span>    * future turn of the JavaScript event loop.
<span class='line'>308</span>    * @param {*} error The error value to report.
<span class='line'>309</span>    * @return {number} The key for the registered timeout.
<span class='line'>310</span>    */</span><span class="WHIT">
<span class='line'>311</span> </span><span class="WHIT">  </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">propagateError</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>312</span> </span><span class="WHIT">    </span><span class="NAME">flow.pendingRejections_</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>313</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">flow.timer.setTimeout</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>314</span> </span><span class="WHIT">      </span><span class="NAME">flow.pendingRejections_</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>315</span> </span><span class="WHIT">      </span><span class="NAME">flow.abortFrame_</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>316</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>317</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>318</span> 
<span class='line'>319</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>320</span>    * Notifies a single listener of this Deferred's change in state.
<span class='line'>321</span>    * @param {!webdriver.promise.Deferred.Listener_} listener The listener to
<span class='line'>322</span>    *     notify.
<span class='line'>323</span>    */</span><span class="WHIT">
<span class='line'>324</span> </span><span class="WHIT">  </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">notify</span><span class="PUNC">(</span><span class="NAME">listener</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>325</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">func</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">state</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred.State_.RESOLVED</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT">
<span class='line'>326</span> </span><span class="WHIT">        </span><span class="NAME">listener.callback</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">listener.errback</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>327</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">func</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>328</span> </span><span class="WHIT">      </span><span class="NAME">flow.runInNewFrame_</span><span class="PUNC">(</span><span class="NAME">goog.partial</span><span class="PUNC">(</span><span class="NAME">func</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>329</span> </span><span class="WHIT">          </span><span class="NAME">listener.fulfill</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">listener.reject</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>330</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">state</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred.State_.REJECTED</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>331</span> </span><span class="WHIT">      </span><span class="NAME">listener.reject</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>332</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>333</span> </span><span class="WHIT">      </span><span class="NAME">listener.fulfill</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>334</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>335</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>336</span> 
<span class='line'>337</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>338</span>    * The consumer promise for this instance. Provides protected access to the
<span class='line'>339</span>    * callback registering functions.
<span class='line'>340</span>    * @type {!webdriver.promise.Promise}
<span class='line'>341</span>    */</span><span class="WHIT">
<span class='line'>342</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">promise</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Promise</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>343</span> 
<span class='line'>344</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>345</span>    * Registers a callback on this Deferred.
<span class='line'>346</span>    * @param {Function=} opt_callback The callback.
<span class='line'>347</span>    * @param {Function=} opt_errback The errback.
<span class='line'>348</span>    * @return {!webdriver.promise.Promise} A new promise representing the result
<span class='line'>349</span>    *     of the callback.
<span class='line'>350</span>    * @see webdriver.promise.Promise#then
<span class='line'>351</span>    */</span><span class="WHIT">
<span class='line'>352</span> </span><span class="WHIT">  </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">then</span><span class="PUNC">(</span><span class="NAME">opt_callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_errback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>353</span> </span><span class="WHIT">    </span><span class="COMM">// Avoid unnecessary allocations if we weren't given any callback functions.</span><span class="WHIT">
<span class='line'>354</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">opt_callback</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">opt_errback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>355</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">promise</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>356</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>357</span> 
<span class='line'>358</span> </span><span class="WHIT">    </span><span class="COMM">// The moment a listener is registered, we consider this deferred to be</span><span class="WHIT">
<span class='line'>359</span> </span><span class="WHIT">    </span><span class="COMM">// handled; the callback must handle any rejection errors.</span><span class="WHIT">
<span class='line'>360</span> </span><span class="WHIT">    </span><span class="NAME">handled</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>361</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">pendingRejectionKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>362</span> </span><span class="WHIT">      </span><span class="NAME">flow.pendingRejections_</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>363</span> </span><span class="WHIT">      </span><span class="NAME">flow.timer.clearTimeout</span><span class="PUNC">(</span><span class="NAME">pendingRejectionKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>364</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>365</span> 
<span class='line'>366</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">deferred</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred</span><span class="PUNC">(</span><span class="NAME">cancel</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">flow</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>367</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">listener</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>368</span> </span><span class="WHIT">      </span><span class="NAME">callback</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">opt_callback</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>369</span> </span><span class="WHIT">      </span><span class="NAME">errback</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">opt_errback</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>370</span> </span><span class="WHIT">      </span><span class="NAME">fulfill</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">deferred.fulfill</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>371</span> </span><span class="WHIT">      </span><span class="NAME">reject</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">deferred.reject</span><span class="WHIT">
<span class='line'>372</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>373</span> 
<span class='line'>374</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">state</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred.State_.PENDING</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>375</span> </span><span class="WHIT">      </span><span class="NAME">listeners.push</span><span class="PUNC">(</span><span class="NAME">listener</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>376</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>377</span> </span><span class="WHIT">      </span><span class="NAME">notify</span><span class="PUNC">(</span><span class="NAME">listener</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>378</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>379</span> 
<span class='line'>380</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">deferred.promise</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>381</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>382</span> 
<span class='line'>383</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">self</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>384</span> 
<span class='line'>385</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>386</span>    * Resolves this promise with the given value. If the value is itself a
<span class='line'>387</span>    * promise and not a reference to this deferred, this instance will wait for
<span class='line'>388</span>    * it before resolving.
<span class='line'>389</span>    * @param {*=} opt_value The resolved value.
<span class='line'>390</span>    */</span><span class="WHIT">
<span class='line'>391</span> </span><span class="WHIT">  </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">fulfill</span><span class="PUNC">(</span><span class="NAME">opt_value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>392</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">webdriver.promise.isPromise</span><span class="PUNC">(</span><span class="NAME">opt_value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">opt_value</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">self</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>393</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">opt_value</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>394</span> </span><span class="WHIT">        </span><span class="NAME">opt_value.then</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>395</span> </span><span class="WHIT">            </span><span class="NAME">goog.partial</span><span class="PUNC">(</span><span class="NAME">notifyAll</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred.State_.RESOLVED</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>396</span> </span><span class="WHIT">            </span><span class="NAME">goog.partial</span><span class="PUNC">(</span><span class="NAME">notifyAll</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>397</span> </span><span class="WHIT">                </span><span class="NAME">webdriver.promise.Deferred.State_.REJECTED</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>398</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>399</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>400</span> </span><span class="WHIT">      </span><span class="NAME">webdriver.promise.asap</span><span class="PUNC">(</span><span class="NAME">opt_value</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">fulfill</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">reject</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>401</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>402</span> </span><span class="WHIT">      </span><span class="NAME">notifyAll</span><span class="PUNC">(</span><span class="NAME">webdriver.promise.Deferred.State_.RESOLVED</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>403</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>404</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>405</span> 
<span class='line'>406</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>407</span>    * Rejects this promise. If the error is itself a promise, this instance will
<span class='line'>408</span>    * be chained to it and be rejected with the error's resolved value.
<span class='line'>409</span>    * @param {*=} opt_error The rejection reason, typically either a
<span class='line'>410</span>    *     {@code Error} or a {@code string}.
<span class='line'>411</span>    */</span><span class="WHIT">
<span class='line'>412</span> </span><span class="WHIT">  </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">reject</span><span class="PUNC">(</span><span class="NAME">opt_error</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>413</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">handleRejection</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>414</span> </span><span class="WHIT">      </span><span class="COMM">// We cannot check instanceof Error since the object may have been</span><span class="WHIT">
<span class='line'>415</span> </span><span class="WHIT">      </span><span class="COMM">// created in a different JS context.</span><span class="WHIT">
<span class='line'>416</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">goog.isObject</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">goog.isString</span><span class="PUNC">(</span><span class="NAME">error.message</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>417</span> </span><span class="WHIT">        </span><span class="NAME">error</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">flow.annotateError</span><span class="PUNC">(</span><span class="COMM">/** @type {!Error} */</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>418</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>419</span> </span><span class="WHIT">      </span><span class="NAME">notifyAll</span><span class="PUNC">(</span><span class="NAME">webdriver.promise.Deferred.State_.REJECTED</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">error</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>420</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>421</span> 
<span class='line'>422</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">webdriver.promise.isPromise</span><span class="PUNC">(</span><span class="NAME">opt_error</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">opt_error</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">self</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>423</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">opt_error</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>424</span> </span><span class="WHIT">        </span><span class="NAME">opt_error.then</span><span class="PUNC">(</span><span class="NAME">handleRejection</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">handleRejection</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>425</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>426</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>427</span> </span><span class="WHIT">      </span><span class="NAME">webdriver.promise.asap</span><span class="PUNC">(</span><span class="NAME">opt_error</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">handleRejection</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">handleRejection</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>428</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>429</span> </span><span class="WHIT">      </span><span class="NAME">handleRejection</span><span class="PUNC">(</span><span class="NAME">opt_error</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>430</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>431</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>432</span> 
<span class='line'>433</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>434</span>    * Attempts to cancel the computation of this instance's value. This attempt
<span class='line'>435</span>    * will silently fail if this instance has already resolved.
<span class='line'>436</span>    * @param {*=} opt_reason The reason for cancelling this promise.
<span class='line'>437</span>    */</span><span class="WHIT">
<span class='line'>438</span> </span><span class="WHIT">  </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">cancel</span><span class="PUNC">(</span><span class="NAME">opt_reason</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>439</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">isPending</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>440</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>441</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>442</span> 
<span class='line'>443</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">opt_canceller</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>444</span> </span><span class="WHIT">      </span><span class="NAME">opt_reason</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">opt_canceller</span><span class="PUNC">(</span><span class="NAME">opt_reason</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">opt_reason</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>445</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>446</span> 
<span class='line'>447</span> </span><span class="WHIT">    </span><span class="COMM">// Only reject this promise if it is still pending after calling its</span><span class="WHIT">
<span class='line'>448</span> </span><span class="WHIT">    </span><span class="COMM">// canceller function. This is because the user may have injected a</span><span class="WHIT">
<span class='line'>449</span> </span><span class="WHIT">    </span><span class="COMM">// canceller that directly rejects (or resolves) this promise's value. The</span><span class="WHIT">
<span class='line'>450</span> </span><span class="WHIT">    </span><span class="COMM">// more likely scenario, however, is that this promise is chained off</span><span class="WHIT">
<span class='line'>451</span> </span><span class="WHIT">    </span><span class="COMM">// another. Once the cancellation request reaches the root deferred, the</span><span class="WHIT">
<span class='line'>452</span> </span><span class="WHIT">    </span><span class="COMM">// subsequent rejection will trickle back down.</span><span class="WHIT">
<span class='line'>453</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isPending</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>454</span> </span><span class="WHIT">      </span><span class="NAME">reject</span><span class="PUNC">(</span><span class="NAME">opt_reason</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>455</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>456</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>457</span> 
<span class='line'>458</span> </span><span class="WHIT">  </span><span class="NAME">this.promise</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">promise</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>459</span> </span><span class="WHIT">  </span><span class="NAME">this.promise.then</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.then</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">then</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>460</span> </span><span class="WHIT">  </span><span class="NAME">this.promise.cancel</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.cancel</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cancel</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>461</span> </span><span class="WHIT">  </span><span class="NAME">this.promise.isPending</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.isPending</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">isPending</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>462</span> </span><span class="WHIT">  </span><span class="NAME">this.fulfill</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fulfill</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>463</span> </span><span class="WHIT">  </span><span class="NAME">this.reject</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.errback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">reject</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>464</span> 
<span class='line'>465</span> </span><span class="WHIT">  </span><span class="COMM">// Only expose this function to our internal classes.</span><span class="WHIT">
<span class='line'>466</span> </span><span class="WHIT">  </span><span class="COMM">// TODO: find a cleaner way of handling this.</span><span class="WHIT">
<span class='line'>467</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">this</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Task_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>468</span> </span><span class="WHIT">    </span><span class="NAME">this.removeAll</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">removeAll</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>469</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>470</span> 
<span class='line'>471</span> </span><span class="WHIT">  </span><span class="COMM">// Export symbols necessary for the contract on this object to work in</span><span class="WHIT">
<span class='line'>472</span> </span><span class="WHIT">  </span><span class="COMM">// compiled mode.</span><span class="WHIT">
<span class='line'>473</span> </span><span class="WHIT">  </span><span class="NAME">goog.exportProperty</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'then'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.then</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>474</span> </span><span class="WHIT">  </span><span class="NAME">goog.exportProperty</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'cancel'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">cancel</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>475</span> </span><span class="WHIT">  </span><span class="NAME">goog.exportProperty</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'fulfill'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">fulfill</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>476</span> </span><span class="WHIT">  </span><span class="NAME">goog.exportProperty</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'reject'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">reject</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>477</span> </span><span class="WHIT">  </span><span class="NAME">goog.exportProperty</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'isPending'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">isPending</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>478</span> </span><span class="WHIT">  </span><span class="NAME">goog.exportProperty</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'promise'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.promise</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>479</span> </span><span class="WHIT">  </span><span class="NAME">goog.exportProperty</span><span class="PUNC">(</span><span class="NAME">this.promise</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'then'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.then</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>480</span> </span><span class="WHIT">  </span><span class="NAME">goog.exportProperty</span><span class="PUNC">(</span><span class="NAME">this.promise</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'cancel'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">cancel</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>481</span> </span><span class="WHIT">  </span><span class="NAME">goog.exportProperty</span><span class="PUNC">(</span><span class="NAME">this.promise</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'isPending'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">isPending</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>482</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>483</span> </span><span class="NAME">goog.inherits</span><span class="PUNC">(</span><span class="NAME">webdriver.promise.Deferred</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Promise</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>484</span> 
<span class='line'>485</span> 
<span class='line'>486</span> </span><span class="COMM">/**
<span class='line'>487</span>  * Type definition for a listener registered on a Deferred object.
<span class='line'>488</span>  * @typedef {{callback:(Function|undefined),
<span class='line'>489</span>  *            errback:(Function|undefined),
<span class='line'>490</span>  *            fulfill: function(*), reject: function(*)}}
<span class='line'>491</span>  * @private
<span class='line'>492</span>  */</span><span class="WHIT">
<span class='line'>493</span> </span><span class="NAME">webdriver.promise.Deferred.Listener_</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>494</span> 
<span class='line'>495</span> 
<span class='line'>496</span> </span><span class="COMM">/**
<span class='line'>497</span>  * The three states a {@code webdriver.promise.Deferred} object may be in.
<span class='line'>498</span>  * @enum {number}
<span class='line'>499</span>  * @private
<span class='line'>500</span>  */</span><span class="WHIT">
<span class='line'>501</span> </span><span class="NAME">webdriver.promise.Deferred.State_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>502</span> </span><span class="WHIT">  </span><span class="NAME">REJECTED</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>503</span> </span><span class="WHIT">  </span><span class="NAME">PENDING</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>504</span> </span><span class="WHIT">  </span><span class="NAME">RESOLVED</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT">
<span class='line'>505</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>506</span> 
<span class='line'>507</span> 
<span class='line'>508</span> </span><span class="COMM">/**
<span class='line'>509</span>  * Tests if a value is an Error-like object. This is more than an straight
<span class='line'>510</span>  * instanceof check since the value may originate from another context.
<span class='line'>511</span>  * @param {*} value The value to test.
<span class='line'>512</span>  * @return {boolean} Whether the value is an error.
<span class='line'>513</span>  * @private
<span class='line'>514</span>  */</span><span class="WHIT">
<span class='line'>515</span> </span><span class="NAME">webdriver.promise.isError_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>516</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">value</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class='line'>517</span> </span><span class="WHIT">      </span><span class="NAME">goog.isObject</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>518</span> </span><span class="WHIT">      </span><span class="PUNC">(</span><span class="NAME">Object.prototype.toString.call</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'[object Error]'</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class='line'>519</span> </span><span class="WHIT">       </span><span class="COMM">// A special test for goog.testing.JsUnitException.</span><span class="WHIT">
<span class='line'>520</span> </span><span class="WHIT">       </span><span class="NAME">value.isJsUnitException</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>521</span> 
<span class='line'>522</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>523</span> 
<span class='line'>524</span> 
<span class='line'>525</span> </span><span class="COMM">/**
<span class='line'>526</span>  * Determines whether a {@code value} should be treated as a promise.
<span class='line'>527</span>  * Any object whose "then" property is a function will be considered a promise.
<span class='line'>528</span>  *
<span class='line'>529</span>  * @param {*} value The value to test.
<span class='line'>530</span>  * @return {boolean} Whether the value is a promise.
<span class='line'>531</span>  */</span><span class="WHIT">
<span class='line'>532</span> </span><span class="NAME">webdriver.promise.isPromise</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>533</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">!</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">goog.isObject</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>534</span> </span><span class="WHIT">      </span><span class="COMM">// Use array notation so the Closure compiler does not obfuscate away our</span><span class="WHIT">
<span class='line'>535</span> </span><span class="WHIT">      </span><span class="COMM">// contract.</span><span class="WHIT">
<span class='line'>536</span> </span><span class="WHIT">      </span><span class="NAME">goog.isFunction</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">[</span><span class="STRN">'then'</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>537</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>538</span> 
<span class='line'>539</span> 
<span class='line'>540</span> </span><span class="COMM">/**
<span class='line'>541</span>  * Creates a promise that will be resolved at a set time in the future.
<span class='line'>542</span>  * @param {number} ms The amount of time, in milliseconds, to wait before
<span class='line'>543</span>  *     resolving the promise.
<span class='line'>544</span>  * @return {!webdriver.promise.Promise} The promise.
<span class='line'>545</span>  */</span><span class="WHIT">
<span class='line'>546</span> </span><span class="NAME">webdriver.promise.delayed</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">ms</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>547</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">timer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.controlFlow</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">timer</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>548</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">key</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>549</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">deferred</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>550</span> </span><span class="WHIT">    </span><span class="NAME">timer.clearTimeout</span><span class="PUNC">(</span><span class="NAME">key</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>551</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>552</span> </span><span class="WHIT">  </span><span class="NAME">key</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">timer.setTimeout</span><span class="PUNC">(</span><span class="NAME">deferred.fulfill</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ms</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>553</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">deferred.promise</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>554</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>555</span> 
<span class='line'>556</span> 
<span class='line'>557</span> </span><span class="COMM">/**
<span class='line'>558</span>  * Creates a new deferred object.
<span class='line'>559</span>  * @param {Function=} opt_canceller Function to call when cancelling the
<span class='line'>560</span>  *     computation of this instance's value.
<span class='line'>561</span>  * @return {!webdriver.promise.Deferred} The new deferred object.
<span class='line'>562</span>  */</span><span class="WHIT">
<span class='line'>563</span> </span><span class="NAME">webdriver.promise.defer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">opt_canceller</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>564</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred</span><span class="PUNC">(</span><span class="NAME">opt_canceller</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>565</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>566</span> 
<span class='line'>567</span> 
<span class='line'>568</span> </span><span class="COMM">/**
<span class='line'>569</span>  * Creates a promise that has been resolved with the given value.
<span class='line'>570</span>  * @param {*=} opt_value The resolved value.
<span class='line'>571</span>  * @return {!webdriver.promise.Promise} The resolved promise.
<span class='line'>572</span>  */</span><span class="WHIT">
<span class='line'>573</span> </span><span class="NAME">webdriver.promise.fulfilled</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">opt_value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>574</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">opt_value</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Promise</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>575</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">opt_value</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>576</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>577</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">deferred</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>578</span> </span><span class="WHIT">  </span><span class="NAME">deferred.fulfill</span><span class="PUNC">(</span><span class="NAME">opt_value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>579</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">deferred.promise</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>580</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>581</span> 
<span class='line'>582</span> 
<span class='line'>583</span> </span><span class="COMM">/**
<span class='line'>584</span>  * Creates a promise that has been rejected with the given reason.
<span class='line'>585</span>  * @param {*=} opt_reason The rejection reason; may be any value, but is
<span class='line'>586</span>  *     usually an Error or a string.
<span class='line'>587</span>  * @return {!webdriver.promise.Promise} The rejected promise.
<span class='line'>588</span>  */</span><span class="WHIT">
<span class='line'>589</span> </span><span class="NAME">webdriver.promise.rejected</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">opt_reason</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>590</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">deferred</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>591</span> </span><span class="WHIT">  </span><span class="NAME">deferred.reject</span><span class="PUNC">(</span><span class="NAME">opt_reason</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>592</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">deferred.promise</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>593</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>594</span> 
<span class='line'>595</span> 
<span class='line'>596</span> </span><span class="COMM">/**
<span class='line'>597</span>  * Wraps a function that is assumed to be a node-style callback as its final
<span class='line'>598</span>  * argument. This callback takes two arguments: an error value (which will be
<span class='line'>599</span>  * null if the call succeeded), and the success value as the second argument.
<span class='line'>600</span>  * If the call fails, the returned promise will be rejected, otherwise it will
<span class='line'>601</span>  * be resolved with the result.
<span class='line'>602</span>  * @param {!Function} fn The function to wrap.
<span class='line'>603</span>  * @return {!webdriver.promise.Promise} A promise that will be resolved with the
<span class='line'>604</span>  *     result of the provided function's callback.
<span class='line'>605</span>  */</span><span class="WHIT">
<span class='line'>606</span> </span><span class="NAME">webdriver.promise.checkedNodeCall</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">fn</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>607</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">deferred</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>608</span> </span><span class="WHIT">    </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">'This Deferred may not be cancelled'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>609</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>610</span> </span><span class="WHIT">  </span><span class="KEYW">try</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>611</span> </span><span class="WHIT">    </span><span class="NAME">fn</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>612</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">deferred.isPending</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>613</span> </span><span class="WHIT">        </span><span class="NAME">error</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">deferred.reject</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">deferred.fulfill</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>614</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>615</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>616</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">catch</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ex</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>617</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">deferred.isPending</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>618</span> </span><span class="WHIT">      </span><span class="NAME">deferred.reject</span><span class="PUNC">(</span><span class="NAME">ex</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>619</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>620</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>621</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">deferred.promise</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>622</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>623</span> 
<span class='line'>624</span> 
<span class='line'>625</span> </span><span class="COMM">/**
<span class='line'>626</span>  * Registers an observer on a promised {@code value}, returning a new promise
<span class='line'>627</span>  * that will be resolved when the value is. If {@code value} is not a promise,
<span class='line'>628</span>  * then the return promise will be immediately resolved.
<span class='line'>629</span>  * @param {*} value The value to observe.
<span class='line'>630</span>  * @param {Function=} opt_callback The function to call when the value is
<span class='line'>631</span>  *     resolved successfully.
<span class='line'>632</span>  * @param {Function=} opt_errback The function to call when the value is
<span class='line'>633</span>  *     rejected.
<span class='line'>634</span>  * @return {!webdriver.promise.Promise} A new promise.
<span class='line'>635</span>  */</span><span class="WHIT">
<span class='line'>636</span> </span><span class="NAME">webdriver.promise.when</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_errback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>637</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">value</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Promise</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>638</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">value.then</span><span class="PUNC">(</span><span class="NAME">opt_callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_errback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>639</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>640</span> 
<span class='line'>641</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">deferred</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>642</span> 
<span class='line'>643</span> </span><span class="WHIT">  </span><span class="NAME">webdriver.promise.asap</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>644</span> </span><span class="WHIT">      </span><span class="NAME">goog.partial</span><span class="PUNC">(</span><span class="NAME">maybeResolve</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">deferred.fulfill</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>645</span> </span><span class="WHIT">      </span><span class="NAME">goog.partial</span><span class="PUNC">(</span><span class="NAME">maybeResolve</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">deferred.reject</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>646</span> 
<span class='line'>647</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">deferred.then</span><span class="PUNC">(</span><span class="NAME">opt_callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_errback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>648</span> 
<span class='line'>649</span> </span><span class="WHIT">  </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">maybeResolve</span><span class="PUNC">(</span><span class="NAME">resolveFn</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>650</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">deferred.isPending</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>651</span> </span><span class="WHIT">      </span><span class="NAME">resolveFn</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>652</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>653</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>654</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>655</span> 
<span class='line'>656</span> 
<span class='line'>657</span> </span><span class="COMM">/**
<span class='line'>658</span>  * Invokes the appropriate callback function as soon as a promised
<span class='line'>659</span>  * {@code value} is resolved. This function is similar to
<span class='line'>660</span>  * {@link webdriver.promise.when}, except it does not return a new promise.
<span class='line'>661</span>  * @param {*} value The value to observe.
<span class='line'>662</span>  * @param {Function} callback The function to call when the value is
<span class='line'>663</span>  *     resolved successfully.
<span class='line'>664</span>  * @param {Function=} opt_errback The function to call when the value is
<span class='line'>665</span>  *     rejected.
<span class='line'>666</span>  */</span><span class="WHIT">
<span class='line'>667</span> </span><span class="NAME">webdriver.promise.asap</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_errback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>668</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">webdriver.promise.isPromise</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>669</span> </span><span class="WHIT">    </span><span class="NAME">value.then</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_errback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>670</span> 
<span class='line'>671</span> </span><span class="WHIT">  </span><span class="COMM">// Maybe a Dojo-like deferred object?</span><span class="WHIT">
<span class='line'>672</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">!</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">goog.isObject</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>673</span> </span><span class="WHIT">      </span><span class="NAME">goog.isFunction</span><span class="PUNC">(</span><span class="NAME">value.addCallbacks</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>674</span> </span><span class="WHIT">    </span><span class="NAME">value.addCallbacks</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_errback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>675</span> 
<span class='line'>676</span> </span><span class="WHIT">  </span><span class="COMM">// A raw value, return a resolved promise.</span><span class="WHIT">
<span class='line'>677</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>678</span> </span><span class="WHIT">    </span><span class="NAME">callback</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>679</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>680</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>681</span> 
<span class='line'>682</span> 
<span class='line'>683</span> </span><span class="COMM">/**
<span class='line'>684</span>  * Returns a promise that will be resolved with the input value in a
<span class='line'>685</span>  * fully-resolved state. If the value is an array, each element will be fully
<span class='line'>686</span>  * resolved. Likewise, if the value is an object, all keys will be fully
<span class='line'>687</span>  * resolved. In both cases, all nested arrays and objects will also be
<span class='line'>688</span>  * fully resolved.  All fields are resolved in place; the returned promise will
<span class='line'>689</span>  * resolve on {@code value} and not a copy.
<span class='line'>690</span>  *
<span class='line'>691</span>  * Warning: This function makes no checks against objects that contain
<span class='line'>692</span>  * cyclical references:
<span class='line'>693</span>  * &lt;pre>&lt;code>
<span class='line'>694</span>  *   var value = {};
<span class='line'>695</span>  *   value['self'] = value;
<span class='line'>696</span>  *   webdriver.promise.fullyResolved(value);  // Stack overflow.
<span class='line'>697</span>  * &lt;/code>&lt;/pre>
<span class='line'>698</span>  *
<span class='line'>699</span>  * @param {*} value The value to fully resolve.
<span class='line'>700</span>  * @return {!webdriver.promise.Promise} A promise for a fully resolved version
<span class='line'>701</span>  *     of the input value.
<span class='line'>702</span>  */</span><span class="WHIT">
<span class='line'>703</span> </span><span class="NAME">webdriver.promise.fullyResolved</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>704</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">webdriver.promise.isPromise</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>705</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.when</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.fullyResolveValue_</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>706</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>707</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.fullyResolveValue_</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>708</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>709</span> 
<span class='line'>710</span> 
<span class='line'>711</span> </span><span class="COMM">/**
<span class='line'>712</span>  * @param {*} value The value to fully resolve. If a promise, assumed to
<span class='line'>713</span>  *     already be resolved.
<span class='line'>714</span>  * @return {!webdriver.promise.Promise} A promise for a fully resolved version
<span class='line'>715</span>  *     of the input value.
<span class='line'>716</span>  * @private
<span class='line'>717</span>  */</span><span class="WHIT">
<span class='line'>718</span> </span><span class="NAME">webdriver.promise.fullyResolveValue_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>719</span> </span><span class="WHIT">  </span><span class="KEYW">switch</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">goog.typeOf</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>720</span> </span><span class="WHIT">    </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">'array'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>721</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.fullyResolveKeys_</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>722</span> </span><span class="WHIT">          </span><span class="COMM">/** @type {!Array} */</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>723</span> 
<span class='line'>724</span> </span><span class="WHIT">    </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">'object'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>725</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">webdriver.promise.isPromise</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>726</span> </span><span class="WHIT">        </span><span class="COMM">// We get here when the original input value is a promise that</span><span class="WHIT">
<span class='line'>727</span> </span><span class="WHIT">        </span><span class="COMM">// resolves to itself. When the user provides us with such a promise,</span><span class="WHIT">
<span class='line'>728</span> </span><span class="WHIT">        </span><span class="COMM">// trust that it counts as a "fully resolved" value and return it.</span><span class="WHIT">
<span class='line'>729</span> </span><span class="WHIT">        </span><span class="COMM">// Of course, since it's already a promise, we can just return it</span><span class="WHIT">
<span class='line'>730</span> </span><span class="WHIT">        </span><span class="COMM">// to the user instead of wrapping it in another promise.</span><span class="WHIT">
<span class='line'>731</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="COMM">/** @type {!webdriver.promise.Promise} */</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>732</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>733</span> 
<span class='line'>734</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">goog.isNumber</span><span class="PUNC">(</span><span class="NAME">value.nodeType</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>735</span> </span><span class="WHIT">          </span><span class="NAME">goog.isObject</span><span class="PUNC">(</span><span class="NAME">value.ownerDocument</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>736</span> </span><span class="WHIT">          </span><span class="NAME">goog.isNumber</span><span class="PUNC">(</span><span class="NAME">value.ownerDocument.nodeType</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>737</span> </span><span class="WHIT">        </span><span class="COMM">// DOM node; return early to avoid infinite recursion. Should we</span><span class="WHIT">
<span class='line'>738</span> </span><span class="WHIT">        </span><span class="COMM">// only support objects with a certain level of nesting?</span><span class="WHIT">
<span class='line'>739</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.fulfilled</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>740</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>741</span> 
<span class='line'>742</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.fullyResolveKeys_</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>743</span> </span><span class="WHIT">          </span><span class="COMM">/** @type {!Object} */</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>744</span> 
<span class='line'>745</span> </span><span class="WHIT">    </span><span class="KEYW">default</span><span class="PUNC">:</span><span class="WHIT">  </span><span class="COMM">// boolean, function, null, number, string, undefined</span><span class="WHIT">
<span class='line'>746</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.fulfilled</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>747</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>748</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>749</span> 
<span class='line'>750</span> 
<span class='line'>751</span> </span><span class="COMM">/**
<span class='line'>752</span>  * @param {!(Array|Object)} obj the object to resolve.
<span class='line'>753</span>  * @return {!webdriver.promise.Promise} A promise that will be resolved with the
<span class='line'>754</span>  *     input object once all of its values have been fully resolved.
<span class='line'>755</span>  * @private
<span class='line'>756</span>  */</span><span class="WHIT">
<span class='line'>757</span> </span><span class="NAME">webdriver.promise.fullyResolveKeys_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>758</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">isArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">goog.isArray</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>759</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">numKeys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">isArray</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">obj.length</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">goog.object.getCount</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>760</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">numKeys</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>761</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.fulfilled</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>762</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>763</span> 
<span class='line'>764</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">numResolved</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>765</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">deferred</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>766</span> 
<span class='line'>767</span> </span><span class="WHIT">  </span><span class="COMM">// In pre-IE9, goog.array.forEach will not iterate properly over arrays</span><span class="WHIT">
<span class='line'>768</span> </span><span class="WHIT">  </span><span class="COMM">// containing undefined values because "index in array" returns false</span><span class="WHIT">
<span class='line'>769</span> </span><span class="WHIT">  </span><span class="COMM">// when array[index] === undefined (even for x = [undefined, 1]). To get</span><span class="WHIT">
<span class='line'>770</span> </span><span class="WHIT">  </span><span class="COMM">// around this, we need to use our own forEach implementation.</span><span class="WHIT">
<span class='line'>771</span> </span><span class="WHIT">  </span><span class="COMM">// DO NOT REMOVE THIS UNTIL WE NO LONGER SUPPORT IE8. This cannot be</span><span class="WHIT">
<span class='line'>772</span> </span><span class="WHIT">  </span><span class="COMM">// reproduced in IE9 by changing the browser/document modes, it requires an</span><span class="WHIT">
<span class='line'>773</span> </span><span class="WHIT">  </span><span class="COMM">// actual pre-IE9 browser.  Yay, IE!</span><span class="WHIT">
<span class='line'>774</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">forEachKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">isArray</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">goog.object.forEach</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">arr</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">fn</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>775</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">n</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">arr.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>776</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">n</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">++</span><span class="NAME">i</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>777</span> </span><span class="WHIT">      </span><span class="NAME">fn.call</span><span class="PUNC">(</span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">arr</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">arr</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>778</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>779</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>780</span> 
<span class='line'>781</span> </span><span class="WHIT">  </span><span class="NAME">forEachKey</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">partialValue</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">key</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>782</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">goog.typeOf</span><span class="PUNC">(</span><span class="NAME">partialValue</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>783</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">'array'</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">'object'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>784</span> </span><span class="WHIT">      </span><span class="NAME">maybeResolveValue</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>785</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>786</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>787</span> 
<span class='line'>788</span> </span><span class="WHIT">    </span><span class="NAME">webdriver.promise.fullyResolved</span><span class="PUNC">(</span><span class="NAME">partialValue</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">then</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>789</span> </span><span class="WHIT">        </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">resolvedValue</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>790</span> </span><span class="WHIT">          </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">deferred.isPending</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>791</span> </span><span class="WHIT">            </span><span class="NAME">obj</span><span class="PUNC">[</span><span class="NAME">key</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">resolvedValue</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>792</span> </span><span class="WHIT">            </span><span class="NAME">maybeResolveValue</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>793</span> </span><span class="WHIT">          </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>794</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>795</span> </span><span class="WHIT">        </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">err</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>796</span> </span><span class="WHIT">          </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">deferred.isPending</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>797</span> </span><span class="WHIT">            </span><span class="NAME">deferred.reject</span><span class="PUNC">(</span><span class="NAME">err</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>798</span> </span><span class="WHIT">          </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>799</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>800</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>801</span> 
<span class='line'>802</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">deferred.promise</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>803</span> 
<span class='line'>804</span> </span><span class="WHIT">  </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">maybeResolveValue</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>805</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">++</span><span class="NAME">numResolved</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">numKeys</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">deferred.isPending</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>806</span> </span><span class="WHIT">      </span><span class="NAME">deferred.fulfill</span><span class="PUNC">(</span><span class="NAME">obj</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>807</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>808</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>809</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>810</span> 
<span class='line'>811</span> 
<span class='line'>812</span> </span><span class="COMM">//////////////////////////////////////////////////////////////////////////////</span><span class="WHIT">
<span class='line'>813</span> </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>814</span> </span><span class="COMM">//  webdriver.promise.ControlFlow</span><span class="WHIT">
<span class='line'>815</span> </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>816</span> </span><span class="COMM">//////////////////////////////////////////////////////////////////////////////</span><span class="WHIT">
<span class='line'>817</span> 
<span class='line'>818</span> 
<span class='line'>819</span> 
<span class='line'>820</span> </span><span class="COMM">/**
<span class='line'>821</span>  * Handles the execution of scheduled tasks, each of which may be an
<span class='line'>822</span>  * asynchronous operation. The control flow will ensure tasks are executed in
<span class='line'>823</span>  * the ordered scheduled, starting each task only once those before it have
<span class='line'>824</span>  * completed.
<span class='line'>825</span>  *
<span class='line'>826</span>  * &lt;p>Each task scheduled within this flow may return a
<span class='line'>827</span>  * {@link webdriver.promise.Promise} to indicate it is an asynchronous
<span class='line'>828</span>  * operation. The ControlFlow will wait for such promises to be resolved before
<span class='line'>829</span>  * marking the task as completed.
<span class='line'>830</span>  *
<span class='line'>831</span>  * &lt;p>Tasks and each callback registered on a {@link webdriver.promise.Deferred}
<span class='line'>832</span>  * will be run in their own ControlFlow frame.  Any tasks scheduled within a
<span class='line'>833</span>  * frame will have priority over previously scheduled tasks. Furthermore, if
<span class='line'>834</span>  * any of the tasks in the frame fails, the remainder of the tasks in that frame
<span class='line'>835</span>  * will be discarded and the failure will be propagated to the user through the
<span class='line'>836</span>  * callback/task's promised result.
<span class='line'>837</span>  *
<span class='line'>838</span>  * &lt;p>Each time a ControlFlow empties its task queue, it will fire an
<span class='line'>839</span>  * {@link webdriver.promise.ControlFlow.EventType.IDLE} event. Conversely,
<span class='line'>840</span>  * whenever the flow terminates due to an unhandled error, it will remove all
<span class='line'>841</span>  * remaining tasks in its queue and fire an
<span class='line'>842</span>  * {@link webdriver.promise.ControlFlow.EventType.UNCAUGHT_EXCEPTION} event. If
<span class='line'>843</span>  * there are no listeners registered with the flow, the error will be
<span class='line'>844</span>  * rethrown to the global error handler.
<span class='line'>845</span>  *
<span class='line'>846</span>  * @param {webdriver.promise.ControlFlow.Timer=} opt_timer The timer object
<span class='line'>847</span>  *     to use. Should only be set for testing.
<span class='line'>848</span>  * @constructor
<span class='line'>849</span>  * @extends {webdriver.EventEmitter}
<span class='line'>850</span>  */</span><span class="WHIT">
<span class='line'>851</span> </span><span class="NAME">webdriver.promise.ControlFlow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">opt_timer</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>852</span> </span><span class="WHIT">  </span><span class="NAME">webdriver.EventEmitter.call</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>853</span> 
<span class='line'>854</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>855</span>    * The timer used by this instance.
<span class='line'>856</span>    * @type {webdriver.promise.ControlFlow.Timer}
<span class='line'>857</span>    */</span><span class="WHIT">
<span class='line'>858</span> </span><span class="WHIT">  </span><span class="NAME">this.timer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">opt_timer</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.ControlFlow.defaultTimer</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>859</span> 
<span class='line'>860</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>861</span>    * A list of recent tasks. Each time a new task is started, or a frame is
<span class='line'>862</span>    * completed, the previously recorded task is removed from this list. If
<span class='line'>863</span>    * there are multiple tasks, task N+1 is considered a sub-task of task
<span class='line'>864</span>    * N.
<span class='line'>865</span>    * @private {!Array.&lt;!webdriver.promise.Task_>}
<span class='line'>866</span>    */</span><span class="WHIT">
<span class='line'>867</span> </span><span class="WHIT">  </span><span class="NAME">this.history_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>868</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>869</span> </span><span class="NAME">goog.inherits</span><span class="PUNC">(</span><span class="NAME">webdriver.promise.ControlFlow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">webdriver.EventEmitter</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>870</span> 
<span class='line'>871</span> 
<span class='line'>872</span> </span><span class="COMM">/**
<span class='line'>873</span>  * @typedef {{clearInterval: function(number),
<span class='line'>874</span>  *            clearTimeout: function(number),
<span class='line'>875</span>  *            setInterval: function(!Function, number): number,
<span class='line'>876</span>  *            setTimeout: function(!Function, number): number}}
<span class='line'>877</span>  */</span><span class="WHIT">
<span class='line'>878</span> </span><span class="NAME">webdriver.promise.ControlFlow.Timer</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>879</span> 
<span class='line'>880</span> 
<span class='line'>881</span> </span><span class="COMM">/**
<span class='line'>882</span>  * The default timer object, which uses the global timer functions.
<span class='line'>883</span>  * @type {webdriver.promise.ControlFlow.Timer}
<span class='line'>884</span>  */</span><span class="WHIT">
<span class='line'>885</span> </span><span class="NAME">webdriver.promise.ControlFlow.defaultTimer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>886</span> </span><span class="WHIT">  </span><span class="COMM">// The default timer functions may be defined as free variables for the</span><span class="WHIT">
<span class='line'>887</span> </span><span class="WHIT">  </span><span class="COMM">// current context, so do not reference them using "window" or</span><span class="WHIT">
<span class='line'>888</span> </span><span class="WHIT">  </span><span class="COMM">// "goog.global".  Also, we must invoke them in a closure, and not using</span><span class="WHIT">
<span class='line'>889</span> </span><span class="WHIT">  </span><span class="COMM">// bind(), so we do not get "TypeError: Illegal invocation" (WebKit) or</span><span class="WHIT">
<span class='line'>890</span> </span><span class="WHIT">  </span><span class="COMM">// "Invalid calling object" (IE) errors.</span><span class="WHIT">
<span class='line'>891</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>892</span> </span><span class="WHIT">    </span><span class="NAME">clearInterval</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">wrap</span><span class="PUNC">(</span><span class="NAME">clearInterval</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>893</span> </span><span class="WHIT">    </span><span class="NAME">clearTimeout</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">wrap</span><span class="PUNC">(</span><span class="NAME">clearTimeout</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>894</span> </span><span class="WHIT">    </span><span class="NAME">setInterval</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">wrap</span><span class="PUNC">(</span><span class="NAME">setInterval</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>895</span> </span><span class="WHIT">    </span><span class="NAME">setTimeout</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">wrap</span><span class="PUNC">(</span><span class="NAME">setTimeout</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>896</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>897</span> 
<span class='line'>898</span> </span><span class="WHIT">  </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">wrap</span><span class="PUNC">(</span><span class="NAME">fn</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>899</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>900</span> </span><span class="WHIT">      </span><span class="COMM">// Cannot use .call() or .apply() since we do not know which variable</span><span class="WHIT">
<span class='line'>901</span> </span><span class="WHIT">      </span><span class="COMM">// the function is bound to, and using the wrong one will generate</span><span class="WHIT">
<span class='line'>902</span> </span><span class="WHIT">      </span><span class="COMM">// an error.</span><span class="WHIT">
<span class='line'>903</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">fn</span><span class="PUNC">(</span><span class="NAME">arguments</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">arguments</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>904</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>905</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>906</span> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>907</span> 
<span class='line'>908</span> 
<span class='line'>909</span> </span><span class="COMM">/**
<span class='line'>910</span>  * Events that may be emitted by an {@link webdriver.promise.ControlFlow}.
<span class='line'>911</span>  * @enum {string}
<span class='line'>912</span>  */</span><span class="WHIT">
<span class='line'>913</span> </span><span class="NAME">webdriver.promise.ControlFlow.EventType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>914</span> 
<span class='line'>915</span> </span><span class="WHIT">  </span><span class="COMM">/** Emitted when all tasks have been successfully executed. */</span><span class="WHIT">
<span class='line'>916</span> </span><span class="WHIT">  </span><span class="NAME">IDLE</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">'idle'</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>917</span> 
<span class='line'>918</span> </span><span class="WHIT">  </span><span class="COMM">/** Emitted whenever a new task has been scheduled. */</span><span class="WHIT">
<span class='line'>919</span> </span><span class="WHIT">  </span><span class="NAME">SCHEDULE_TASK</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">'scheduleTask'</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>920</span> 
<span class='line'>921</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>922</span>    * Emitted whenever a control flow aborts due to an unhandled promise
<span class='line'>923</span>    * rejection. This event will be emitted along with the offending rejection
<span class='line'>924</span>    * reason. Upon emitting this event, the control flow will empty its task
<span class='line'>925</span>    * queue and revert to its initial state.
<span class='line'>926</span>    */</span><span class="WHIT">
<span class='line'>927</span> </span><span class="WHIT">  </span><span class="NAME">UNCAUGHT_EXCEPTION</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">'uncaughtException'</span><span class="WHIT">
<span class='line'>928</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>929</span> 
<span class='line'>930</span> 
<span class='line'>931</span> </span><span class="COMM">/**
<span class='line'>932</span>  * How often, in milliseconds, the event loop should run.
<span class='line'>933</span>  * @type {number}
<span class='line'>934</span>  * @const
<span class='line'>935</span>  */</span><span class="WHIT">
<span class='line'>936</span> </span><span class="NAME">webdriver.promise.ControlFlow.EVENT_LOOP_FREQUENCY</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>937</span> 
<span class='line'>938</span> 
<span class='line'>939</span> </span><span class="COMM">/**
<span class='line'>940</span>  * Tracks the active execution frame for this instance. Lazily initialized
<span class='line'>941</span>  * when the first task is scheduled.
<span class='line'>942</span>  * @private {webdriver.promise.Frame_}
<span class='line'>943</span>  */</span><span class="WHIT">
<span class='line'>944</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.activeFrame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>945</span> 
<span class='line'>946</span> 
<span class='line'>947</span> </span><span class="COMM">/**
<span class='line'>948</span>  * A reference to the frame in which new tasks should be scheduled. If
<span class='line'>949</span>  * {@code null}, tasks will be scheduled within the active frame. When forcing
<span class='line'>950</span>  * a function to run in the context of a new frame, this pointer is used to
<span class='line'>951</span>  * ensure tasks are scheduled within the newly created frame, even though it
<span class='line'>952</span>  * won't be active yet.
<span class='line'>953</span>  * @private {webdriver.promise.Frame_}
<span class='line'>954</span>  * @see {#runInNewFrame_}
<span class='line'>955</span>  */</span><span class="WHIT">
<span class='line'>956</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.schedulingFrame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>957</span> 
<span class='line'>958</span> 
<span class='line'>959</span> </span><span class="COMM">/**
<span class='line'>960</span>  * Timeout ID set when the flow is about to shutdown without any errors
<span class='line'>961</span>  * being detected. Upon shutting down, the flow will emit an
<span class='line'>962</span>  * {@link webdriver.promise.ControlFlow.EventType.IDLE} event. Idle events
<span class='line'>963</span>  * always follow a brief timeout in order to catch latent errors from the last
<span class='line'>964</span>  * completed task. If this task had a callback registered, but no errback, and
<span class='line'>965</span>  * the task fails, the unhandled failure would not be reported by the promise
<span class='line'>966</span>  * system until the next turn of the event loop:
<span class='line'>967</span>  *
<span class='line'>968</span>  *   // Schedule 1 task that fails.
<span class='line'>969</span>  *   var result = webriver.promise.controlFlow().schedule('example',
<span class='line'>970</span>  *       function() { return webdriver.promise.rejected('failed'); });
<span class='line'>971</span>  *   // Set a callback on the result. This delays reporting the unhandled
<span class='line'>972</span>  *   // failure for 1 turn of the event loop.
<span class='line'>973</span>  *   result.then(goog.nullFunction);
<span class='line'>974</span>  *
<span class='line'>975</span>  * @private {?number}
<span class='line'>976</span>  */</span><span class="WHIT">
<span class='line'>977</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.shutdownId_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>978</span> 
<span class='line'>979</span> 
<span class='line'>980</span> </span><span class="COMM">/**
<span class='line'>981</span>  * Interval ID for this instance's event loop.
<span class='line'>982</span>  * @private {?number}
<span class='line'>983</span>  */</span><span class="WHIT">
<span class='line'>984</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.eventLoopId_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>985</span> 
<span class='line'>986</span> 
<span class='line'>987</span> </span><span class="COMM">/**
<span class='line'>988</span>  * The number of "pending" promise rejections.
<span class='line'>989</span>  *
<span class='line'>990</span>  * &lt;p>Each time a promise is rejected and is not handled by a listener, it will
<span class='line'>991</span>  * schedule a 0-based timeout to check if it is still unrejected in the next
<span class='line'>992</span>  * turn of the JS-event loop. This allows listeners to attach to, and handle,
<span class='line'>993</span>  * the rejected promise at any point in same turn of the event loop that the
<span class='line'>994</span>  * promise was rejected.
<span class='line'>995</span>  *
<span class='line'>996</span>  * &lt;p>When this flow's own event loop triggers, it will not run if there
<span class='line'>997</span>  * are any outstanding promise rejections. This allows unhandled promises to
<span class='line'>998</span>  * be reported before a new task is started, ensuring the error is reported to
<span class='line'>999</span>  * the current task queue.
<span class='line'>1000</span>  *
<span class='line'>1001</span>  * @private {number}
<span class='line'>1002</span>  */</span><span class="WHIT">
<span class='line'>1003</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.pendingRejections_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1004</span> 
<span class='line'>1005</span> 
<span class='line'>1006</span> </span><span class="COMM">/**
<span class='line'>1007</span>  * The number of aborted frames since the last time a task was executed or a
<span class='line'>1008</span>  * frame completed successfully.
<span class='line'>1009</span>  * @private {number}
<span class='line'>1010</span>  */</span><span class="WHIT">
<span class='line'>1011</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.numAbortedFrames_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1012</span> 
<span class='line'>1013</span> 
<span class='line'>1014</span> </span><span class="COMM">/**
<span class='line'>1015</span>  * Resets this instance, clearing its queue and removing all event listeners.
<span class='line'>1016</span>  */</span><span class="WHIT">
<span class='line'>1017</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.reset</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1018</span> </span><span class="WHIT">  </span><span class="NAME">this.activeFrame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1019</span> </span><span class="WHIT">  </span><span class="NAME">this.clearHistory</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1020</span> </span><span class="WHIT">  </span><span class="NAME">this.removeAllListeners</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1021</span> </span><span class="WHIT">  </span><span class="NAME">this.cancelShutdown_</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1022</span> </span><span class="WHIT">  </span><span class="NAME">this.cancelEventLoop_</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1023</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1024</span> 
<span class='line'>1025</span> 
<span class='line'>1026</span> </span><span class="COMM">/**
<span class='line'>1027</span>  * Returns a summary of the recent task activity for this instance. This
<span class='line'>1028</span>  * includes the most recently completed task, as well as any parent tasks. In
<span class='line'>1029</span>  * the returned summary, the task at index N is considered a sub-task of the
<span class='line'>1030</span>  * task at index N+1.
<span class='line'>1031</span>  * @return {!Array.&lt;string>} A summary of this instance's recent task
<span class='line'>1032</span>  *     activity.
<span class='line'>1033</span>  */</span><span class="WHIT">
<span class='line'>1034</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.getHistory</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1035</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pendingTasks</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1036</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentFrame</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.activeFrame_</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1037</span> </span><span class="WHIT">  </span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">currentFrame</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1038</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">task</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">currentFrame.getPendingTask</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1039</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">task</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1040</span> </span><span class="WHIT">      </span><span class="NAME">pendingTasks.push</span><span class="PUNC">(</span><span class="NAME">task</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1041</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1042</span> </span><span class="WHIT">    </span><span class="COMM">// A frame's parent node will always be another frame.</span><span class="WHIT">
<span class='line'>1043</span> </span><span class="WHIT">    </span><span class="NAME">currentFrame</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class='line'>1044</span> </span><span class="WHIT">        </span><span class="COMM">/** @type {webdriver.promise.Frame_} */</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">currentFrame.getParent</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1045</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1046</span> 
<span class='line'>1047</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">fullHistory</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">goog.array.concat</span><span class="PUNC">(</span><span class="NAME">this.history_</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pendingTasks</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1048</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">goog.array.map</span><span class="PUNC">(</span><span class="NAME">fullHistory</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">task</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1049</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">task.toString</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1050</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1051</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1052</span> 
<span class='line'>1053</span> 
<span class='line'>1054</span> </span><span class="COMM">/** Clears this instance's task history. */</span><span class="WHIT">
<span class='line'>1055</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.clearHistory</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1056</span> </span><span class="WHIT">  </span><span class="NAME">this.history_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1057</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1058</span> 
<span class='line'>1059</span> 
<span class='line'>1060</span> </span><span class="COMM">/**
<span class='line'>1061</span>  * Removes a completed task from this instance's history record. If any
<span class='line'>1062</span>  * tasks remain from aborted frames, those will be removed as well.
<span class='line'>1063</span>  * @private
<span class='line'>1064</span>  */</span><span class="WHIT">
<span class='line'>1065</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.trimHistory_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1066</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.numAbortedFrames_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1067</span> </span><span class="WHIT">    </span><span class="NAME">goog.array.splice</span><span class="PUNC">(</span><span class="NAME">this.history_</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1068</span> </span><span class="WHIT">        </span><span class="NAME">this.history_.length</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">this.numAbortedFrames_</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1069</span> </span><span class="WHIT">        </span><span class="NAME">this.numAbortedFrames_</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1070</span> </span><span class="WHIT">    </span><span class="NAME">this.numAbortedFrames_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1071</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1072</span> </span><span class="WHIT">  </span><span class="NAME">this.history_.pop</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1073</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1074</span> 
<span class='line'>1075</span> 
<span class='line'>1076</span> </span><span class="COMM">/**
<span class='line'>1077</span>  * Property used to track whether an error has been annotated by
<span class='line'>1078</span>  * {@link webdriver.promise.ControlFlow#annotateError}.
<span class='line'>1079</span>  * @private {string}
<span class='line'>1080</span>  * @const
<span class='line'>1081</span>  */</span><span class="WHIT">
<span class='line'>1082</span> </span><span class="NAME">webdriver.promise.ControlFlow.ANNOTATION_PROPERTY_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class='line'>1083</span> </span><span class="WHIT">    </span><span class="STRN">'webdriver_promise_error_'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1084</span> 
<span class='line'>1085</span> 
<span class='line'>1086</span> </span><span class="COMM">/**
<span class='line'>1087</span>  * Appends a summary of this instance's recent task history to the given
<span class='line'>1088</span>  * error's stack trace. This function will also ensure the error's stack trace
<span class='line'>1089</span>  * is in canonical form.
<span class='line'>1090</span>  * @param {!(Error|goog.testing.JsUnitException)} e The error to annotate.
<span class='line'>1091</span>  * @return {!(Error|goog.testing.JsUnitException)} The annotated error.
<span class='line'>1092</span>  */</span><span class="WHIT">
<span class='line'>1093</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.annotateError</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1094</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">!</span><span class="NAME">e</span><span class="PUNC">[</span><span class="NAME">webdriver.promise.ControlFlow.ANNOTATION_PROPERTY_</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1095</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">e</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1096</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1097</span> 
<span class='line'>1098</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">history</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getHistory</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1099</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">history.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1100</span> </span><span class="WHIT">    </span><span class="NAME">e</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">webdriver.stacktrace.format</span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1101</span> 
<span class='line'>1102</span> </span><span class="WHIT">    </span><span class="COMM">/** @type {!Error} */</span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">stack</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="WHIT">
<span class='line'>1103</span> </span><span class="WHIT">      </span><span class="STRN">'\n==== async task ====\n'</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1104</span> </span><span class="WHIT">      </span><span class="NAME">history.join</span><span class="PUNC">(</span><span class="STRN">'\n==== async task ====\n'</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1105</span> </span><span class="WHIT">    </span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">join</span><span class="PUNC">(</span><span class="STRN">''</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1106</span> 
<span class='line'>1107</span> </span><span class="WHIT">    </span><span class="NAME">e</span><span class="PUNC">[</span><span class="NAME">webdriver.promise.ControlFlow.ANNOTATION_PROPERTY_</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1108</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1109</span> 
<span class='line'>1110</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">e</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1111</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1112</span> 
<span class='line'>1113</span> 
<span class='line'>1114</span> </span><span class="COMM">/**
<span class='line'>1115</span>  * @return {string} The scheduled tasks still pending with this instance.
<span class='line'>1116</span>  */</span><span class="WHIT">
<span class='line'>1117</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.getSchedule</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1118</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.activeFrame_</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">this.activeFrame_.getRoot</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">toString</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">'[]'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1119</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1120</span> 
<span class='line'>1121</span> 
<span class='line'>1122</span> </span><span class="COMM">/**
<span class='line'>1123</span>  * Schedules a task for execution. If there is nothing currently in the
<span class='line'>1124</span>  * queue, the task will be executed in the next turn of the event loop.
<span class='line'>1125</span>  *
<span class='line'>1126</span>  * @param {!Function} fn The function to call to start the task. If the
<span class='line'>1127</span>  *     function returns a {@link webdriver.promise.Promise}, this instance
<span class='line'>1128</span>  *     will wait for it to be resolved before starting the next task.
<span class='line'>1129</span>  * @param {string=} opt_description A description of the task.
<span class='line'>1130</span>  * @return {!webdriver.promise.Promise} A promise that will be resolved with
<span class='line'>1131</span>  *     the result of the action.
<span class='line'>1132</span>  */</span><span class="WHIT">
<span class='line'>1133</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.execute</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>1134</span> </span><span class="WHIT">    </span><span class="NAME">fn</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_description</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1135</span> </span><span class="WHIT">  </span><span class="NAME">this.cancelShutdown_</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1136</span> 
<span class='line'>1137</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.activeFrame_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1138</span> </span><span class="WHIT">    </span><span class="NAME">this.activeFrame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Frame_</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1139</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1140</span> 
<span class='line'>1141</span> </span><span class="WHIT">  </span><span class="COMM">// Trim an extra frame off the generated stack trace for the call to this</span><span class="WHIT">
<span class='line'>1142</span> </span><span class="WHIT">  </span><span class="COMM">// function.</span><span class="WHIT">
<span class='line'>1143</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">snapshot</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.stacktrace.Snapshot</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1144</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">task</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Task_</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>1145</span> </span><span class="WHIT">      </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">fn</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_description</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">''</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">snapshot</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1146</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">scheduleIn</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.schedulingFrame_</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">this.activeFrame_</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1147</span> </span><span class="WHIT">  </span><span class="NAME">scheduleIn.addChild</span><span class="PUNC">(</span><span class="NAME">task</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1148</span> 
<span class='line'>1149</span> </span><span class="WHIT">  </span><span class="NAME">this.emit</span><span class="PUNC">(</span><span class="NAME">webdriver.promise.ControlFlow.EventType.SCHEDULE_TASK</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1150</span> 
<span class='line'>1151</span> </span><span class="WHIT">  </span><span class="NAME">this.scheduleEventLoopStart_</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1152</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">task.promise</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1153</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1154</span> 
<span class='line'>1155</span> 
<span class='line'>1156</span> </span><span class="COMM">/**
<span class='line'>1157</span>  * Inserts a {@code setTimeout} into the command queue. This is equivalent to
<span class='line'>1158</span>  * a thread sleep in a synchronous programming language.
<span class='line'>1159</span>  *
<span class='line'>1160</span>  * @param {number} ms The timeout delay, in milliseconds.
<span class='line'>1161</span>  * @param {string=} opt_description A description to accompany the timeout.
<span class='line'>1162</span>  * @return {!webdriver.promise.Promise} A promise that will be resolved with
<span class='line'>1163</span>  *     the result of the action.
<span class='line'>1164</span>  */</span><span class="WHIT">
<span class='line'>1165</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.timeout</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>1166</span> </span><span class="WHIT">    </span><span class="NAME">ms</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_description</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1167</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.execute</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1168</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.delayed</span><span class="PUNC">(</span><span class="NAME">ms</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1169</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_description</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1170</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1171</span> 
<span class='line'>1172</span> 
<span class='line'>1173</span> </span><span class="COMM">/**
<span class='line'>1174</span>  * Schedules a task that shall wait for a condition to hold. Each condition
<span class='line'>1175</span>  * function may return any value, but it will always be evaluated as a boolean.
<span class='line'>1176</span>  *
<span class='line'>1177</span>  * &lt;p>Condition functions may schedule sub-tasks with this instance, however,
<span class='line'>1178</span>  * their execution time will be factored into whether a wait has timed out.
<span class='line'>1179</span>  *
<span class='line'>1180</span>  * &lt;p>In the event a condition returns a Promise, the polling loop will wait for
<span class='line'>1181</span>  * it to be resolved before evaluating whether the condition has been satisfied.
<span class='line'>1182</span>  * The resolution time for a promise is factored into whether a wait has timed
<span class='line'>1183</span>  * out.
<span class='line'>1184</span>  *
<span class='line'>1185</span>  * &lt;p>If the condition function throws, or returns a rejected promise, the
<span class='line'>1186</span>  * wait task will fail.
<span class='line'>1187</span>  *
<span class='line'>1188</span>  * @param {!Function} condition The condition function to poll.
<span class='line'>1189</span>  * @param {number} timeout How long to wait, in milliseconds, for the condition
<span class='line'>1190</span>  *     to hold before timing out.
<span class='line'>1191</span>  * @param {string=} opt_message An optional error message to include if the
<span class='line'>1192</span>  *     wait times out; defaults to the empty string.
<span class='line'>1193</span>  * @return {!webdriver.promise.Promise} A promise that will be resolved when the
<span class='line'>1194</span>  *     condition has been satisified. The promise shall be rejected if the wait
<span class='line'>1195</span>  *     times out waiting for the condition.
<span class='line'>1196</span>  */</span><span class="WHIT">
<span class='line'>1197</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.wait</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>1198</span> </span><span class="WHIT">    </span><span class="NAME">condition</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">timeout</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_message</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1199</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">sleep</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.min</span><span class="PUNC">(</span><span class="NAME">timeout</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1200</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">self</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1201</span> 
<span class='line'>1202</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.execute</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1203</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">startTime</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">goog.now</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1204</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">waitResult</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1205</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">waitFrame</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">self.activeFrame_</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1206</span> </span><span class="WHIT">    </span><span class="NAME">waitFrame.isWaiting</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1207</span> </span><span class="WHIT">    </span><span class="NAME">pollCondition</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1208</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">waitResult.promise</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1209</span> 
<span class='line'>1210</span> </span><span class="WHIT">    </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">pollCondition</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1211</span> </span><span class="WHIT">      </span><span class="NAME">self.runInNewFrame_</span><span class="PUNC">(</span><span class="NAME">condition</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1212</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">elapsed</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">goog.now</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">startTime</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1213</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">!</span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1214</span> </span><span class="WHIT">          </span><span class="NAME">waitFrame.isWaiting</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1215</span> </span><span class="WHIT">          </span><span class="NAME">waitResult.fulfill</span><span class="PUNC">(</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1216</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">elapsed</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NAME">timeout</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1217</span> </span><span class="WHIT">          </span><span class="NAME">waitResult.reject</span><span class="PUNC">(</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">opt_message</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">opt_message</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'\n'</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">''</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT">
<span class='line'>1218</span> </span><span class="WHIT">              </span><span class="STRN">'Wait timed out after '</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">elapsed</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'ms'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1219</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1220</span> </span><span class="WHIT">          </span><span class="NAME">self.timer.setTimeout</span><span class="PUNC">(</span><span class="NAME">pollCondition</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sleep</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1221</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1222</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">waitResult.reject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1223</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1224</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_message</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1225</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1226</span> 
<span class='line'>1227</span> 
<span class='line'>1228</span> </span><span class="COMM">/**
<span class='line'>1229</span>  * Schedules a task that will wait for another promise to resolve.  The resolved
<span class='line'>1230</span>  * promise's value will be returned as the task result.
<span class='line'>1231</span>  * @param {!webdriver.promise.Promise} promise The promise to wait on.
<span class='line'>1232</span>  * @return {!webdriver.promise.Promise} A promise that will resolve when the
<span class='line'>1233</span>  *     task has completed.
<span class='line'>1234</span>  */</span><span class="WHIT">
<span class='line'>1235</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.await</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">promise</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1236</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.execute</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1237</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">promise</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1238</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1239</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1240</span> 
<span class='line'>1241</span> 
<span class='line'>1242</span> </span><span class="COMM">/**
<span class='line'>1243</span>  * Schedules the interval for this instance's event loop, if necessary.
<span class='line'>1244</span>  * @private
<span class='line'>1245</span>  */</span><span class="WHIT">
<span class='line'>1246</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.scheduleEventLoopStart_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1247</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.eventLoopId_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1248</span> </span><span class="WHIT">    </span><span class="NAME">this.eventLoopId_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.timer.setInterval</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>1249</span> </span><span class="WHIT">        </span><span class="NAME">goog.bind</span><span class="PUNC">(</span><span class="NAME">this.runEventLoop_</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1250</span> </span><span class="WHIT">        </span><span class="NAME">webdriver.promise.ControlFlow.EVENT_LOOP_FREQUENCY</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1251</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1252</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1253</span> 
<span class='line'>1254</span> 
<span class='line'>1255</span> </span><span class="COMM">/**
<span class='line'>1256</span>  * Cancels the event loop, if necessary.
<span class='line'>1257</span>  * @private
<span class='line'>1258</span>  */</span><span class="WHIT">
<span class='line'>1259</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.cancelEventLoop_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1260</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.eventLoopId_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1261</span> </span><span class="WHIT">    </span><span class="NAME">this.timer.clearInterval</span><span class="PUNC">(</span><span class="NAME">this.eventLoopId_</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1262</span> </span><span class="WHIT">    </span><span class="NAME">this.eventLoopId_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1263</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1264</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1265</span> 
<span class='line'>1266</span> 
<span class='line'>1267</span> </span><span class="COMM">/**
<span class='line'>1268</span>  * Executes the next task for the current frame. If the current frame has no
<span class='line'>1269</span>  * more tasks, the frame's result will be resolved, returning control to the
<span class='line'>1270</span>  * frame's creator. This will terminate the flow if the completed frame was at
<span class='line'>1271</span>  * the top of the stack.
<span class='line'>1272</span>  * @private
<span class='line'>1273</span>  */</span><span class="WHIT">
<span class='line'>1274</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.runEventLoop_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1275</span> </span><span class="WHIT">  </span><span class="COMM">// If we get here and there are pending promise rejections, then those</span><span class="WHIT">
<span class='line'>1276</span> </span><span class="WHIT">  </span><span class="COMM">// promises are queued up to run as soon as this (JS) event loop terminates.</span><span class="WHIT">
<span class='line'>1277</span> </span><span class="WHIT">  </span><span class="COMM">// Short-circuit our loop to give those promises a chance to run. Otherwise,</span><span class="WHIT">
<span class='line'>1278</span> </span><span class="WHIT">  </span><span class="COMM">// we might start a new task only to have it fail because of one of these</span><span class="WHIT">
<span class='line'>1279</span> </span><span class="WHIT">  </span><span class="COMM">// pending rejections.</span><span class="WHIT">
<span class='line'>1280</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.pendingRejections_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1281</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1282</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1283</span> 
<span class='line'>1284</span> </span><span class="WHIT">  </span><span class="COMM">// If the flow aborts due to an unhandled exception after we've scheduled</span><span class="WHIT">
<span class='line'>1285</span> </span><span class="WHIT">  </span><span class="COMM">// another turn of the execution loop, we can end up in here with no tasks</span><span class="WHIT">
<span class='line'>1286</span> </span><span class="WHIT">  </span><span class="COMM">// left. This is OK, just quietly return.</span><span class="WHIT">
<span class='line'>1287</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.activeFrame_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1288</span> </span><span class="WHIT">    </span><span class="NAME">this.commenceShutdown_</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1289</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1290</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1291</span> 
<span class='line'>1292</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">task</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1293</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.activeFrame_.getPendingTask</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">task</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getNextTask_</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1294</span> </span><span class="WHIT">    </span><span class="COMM">// Either the current frame is blocked on a pending task, or we don't have</span><span class="WHIT">
<span class='line'>1295</span> </span><span class="WHIT">    </span><span class="COMM">// a task to finish because we've completed a frame. When completing a</span><span class="WHIT">
<span class='line'>1296</span> </span><span class="WHIT">    </span><span class="COMM">// frame, we must abort the event loop to allow the frame's promise's</span><span class="WHIT">
<span class='line'>1297</span> </span><span class="WHIT">    </span><span class="COMM">// callbacks to execute.</span><span class="WHIT">
<span class='line'>1298</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1299</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1300</span> 
<span class='line'>1301</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">activeFrame</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.activeFrame_</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1302</span> </span><span class="WHIT">  </span><span class="NAME">activeFrame.setPendingTask</span><span class="PUNC">(</span><span class="NAME">task</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1303</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">markTaskComplete</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">goog.bind</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1304</span> </span><span class="WHIT">    </span><span class="NAME">this.history_.push</span><span class="PUNC">(</span><span class="COMM">/** @type {!webdriver.promise.Task_} */</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">task</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1305</span> </span><span class="WHIT">    </span><span class="NAME">activeFrame.setPendingTask</span><span class="PUNC">(</span><span class="KEYW">null</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1306</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1307</span> 
<span class='line'>1308</span> </span><span class="WHIT">  </span><span class="NAME">this.trimHistory_</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1309</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">self</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1310</span> </span><span class="WHIT">  </span><span class="NAME">this.runInNewFrame_</span><span class="PUNC">(</span><span class="NAME">task.execute</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">result</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1311</span> </span><span class="WHIT">    </span><span class="NAME">markTaskComplete</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1312</span> </span><span class="WHIT">    </span><span class="NAME">task.fulfill</span><span class="PUNC">(</span><span class="NAME">result</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1313</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1314</span> </span><span class="WHIT">    </span><span class="NAME">markTaskComplete</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1315</span> 
<span class='line'>1316</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">webdriver.promise.isError_</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>1317</span> </span><span class="WHIT">        </span><span class="PUNC">!</span><span class="NAME">webdriver.promise.isPromise</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1318</span> </span><span class="WHIT">      </span><span class="NAME">error</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1319</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1320</span> 
<span class='line'>1321</span> </span><span class="WHIT">    </span><span class="NAME">task.reject</span><span class="PUNC">(</span><span class="NAME">self.annotateError</span><span class="PUNC">(</span><span class="COMM">/** @type {!Error} */</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1322</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1323</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1324</span> 
<span class='line'>1325</span> 
<span class='line'>1326</span> </span><span class="COMM">/**
<span class='line'>1327</span>  * @return {webdriver.promise.Task_} The next task to execute, or
<span class='line'>1328</span>  *     {@code null} if a frame was resolved.
<span class='line'>1329</span>  * @private
<span class='line'>1330</span>  */</span><span class="WHIT">
<span class='line'>1331</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.getNextTask_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1332</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">firstChild</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.activeFrame_.getFirstChild</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1333</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">firstChild</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1334</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.activeFrame_.isWaiting</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1335</span> </span><span class="WHIT">      </span><span class="NAME">this.resolveFrame_</span><span class="PUNC">(</span><span class="NAME">this.activeFrame_</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1336</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1337</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1338</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1339</span> 
<span class='line'>1340</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">firstChild</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Frame_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1341</span> </span><span class="WHIT">    </span><span class="NAME">this.activeFrame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">firstChild</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1342</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.getNextTask_</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1343</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1344</span> 
<span class='line'>1345</span> </span><span class="WHIT">  </span><span class="NAME">firstChild.getParent</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">removeChild</span><span class="PUNC">(</span><span class="NAME">firstChild</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1346</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">firstChild</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1347</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1348</span> 
<span class='line'>1349</span> 
<span class='line'>1350</span> </span><span class="COMM">/**
<span class='line'>1351</span>  * @param {!webdriver.promise.Frame_} frame The frame to resolve.
<span class='line'>1352</span>  * @private
<span class='line'>1353</span>  */</span><span class="WHIT">
<span class='line'>1354</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.resolveFrame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">frame</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1355</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.activeFrame_</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">frame</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1356</span> </span><span class="WHIT">    </span><span class="COMM">// Frame parent is always another frame, but the compiler is not smart</span><span class="WHIT">
<span class='line'>1357</span> </span><span class="WHIT">    </span><span class="COMM">// enough to recognize this.</span><span class="WHIT">
<span class='line'>1358</span> </span><span class="WHIT">    </span><span class="NAME">this.activeFrame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class='line'>1359</span> </span><span class="WHIT">        </span><span class="COMM">/** @type {webdriver.promise.Frame_} */</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">frame.getParent</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1360</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1361</span> 
<span class='line'>1362</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">frame.getParent</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1363</span> </span><span class="WHIT">    </span><span class="NAME">frame.getParent</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">removeChild</span><span class="PUNC">(</span><span class="NAME">frame</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1364</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1365</span> </span><span class="WHIT">  </span><span class="NAME">this.trimHistory_</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1366</span> </span><span class="WHIT">  </span><span class="NAME">frame.fulfill</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1367</span> 
<span class='line'>1368</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.activeFrame_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1369</span> </span><span class="WHIT">    </span><span class="NAME">this.commenceShutdown_</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1370</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1371</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1372</span> 
<span class='line'>1373</span> 
<span class='line'>1374</span> </span><span class="COMM">/**
<span class='line'>1375</span>  * Aborts the current frame. The frame, and all of the tasks scheduled within it
<span class='line'>1376</span>  * will be discarded. If this instance does not have an active frame, it will
<span class='line'>1377</span>  * immediately terminate all execution.
<span class='line'>1378</span>  * @param {*} error The reason the frame is being aborted; typically either
<span class='line'>1379</span>  *     an Error or string.
<span class='line'>1380</span>  * @private
<span class='line'>1381</span>  */</span><span class="WHIT">
<span class='line'>1382</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.abortFrame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1383</span> </span><span class="WHIT">  </span><span class="COMM">// Annotate the error value if it is Error-like.</span><span class="WHIT">
<span class='line'>1384</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">webdriver.promise.isError_</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1385</span> </span><span class="WHIT">    </span><span class="NAME">this.annotateError</span><span class="PUNC">(</span><span class="COMM">/** @type {!Error} */</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1386</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1387</span> </span><span class="WHIT">  </span><span class="NAME">this.numAbortedFrames_</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1388</span> 
<span class='line'>1389</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.activeFrame_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1390</span> </span><span class="WHIT">    </span><span class="NAME">this.abortNow_</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1391</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1392</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1393</span> 
<span class='line'>1394</span> </span><span class="WHIT">  </span><span class="COMM">// Frame parent is always another frame, but the compiler is not smart</span><span class="WHIT">
<span class='line'>1395</span> </span><span class="WHIT">  </span><span class="COMM">// enough to recognize this.</span><span class="WHIT">
<span class='line'>1396</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">parent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="COMM">/** @type {webdriver.promise.Frame_} */</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>1397</span> </span><span class="WHIT">      </span><span class="NAME">this.activeFrame_.getParent</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1398</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">parent</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1399</span> </span><span class="WHIT">    </span><span class="NAME">parent.removeChild</span><span class="PUNC">(</span><span class="NAME">this.activeFrame_</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1400</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1401</span> 
<span class='line'>1402</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">frame</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.activeFrame_</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1403</span> </span><span class="WHIT">  </span><span class="NAME">this.activeFrame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parent</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1404</span> </span><span class="WHIT">  </span><span class="NAME">frame.reject</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1405</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1406</span> 
<span class='line'>1407</span> 
<span class='line'>1408</span> </span><span class="COMM">/**
<span class='line'>1409</span>  * Executes a function in a new frame. If the function does not schedule any new
<span class='line'>1410</span>  * tasks, the frame will be discarded and the function's result returned
<span class='line'>1411</span>  * immediately. Otherwise, a promise will be returned. This promise will be
<span class='line'>1412</span>  * resolved with the function's result once all of the tasks scheduled within
<span class='line'>1413</span>  * the function have been completed. If the function's frame is aborted, the
<span class='line'>1414</span>  * returned promise will be rejected.
<span class='line'>1415</span>  *
<span class='line'>1416</span>  * @param {!Function} fn The function to execute.
<span class='line'>1417</span>  * @param {function(*)} callback The function to call with a successful result.
<span class='line'>1418</span>  * @param {function(*)} errback The function to call if there is an error.
<span class='line'>1419</span>  * @param {boolean=} opt_activate Whether the active frame should be updated to
<span class='line'>1420</span>  *     the newly created frame so tasks are treated as sub-tasks.
<span class='line'>1421</span>  * @private
<span class='line'>1422</span>  */</span><span class="WHIT">
<span class='line'>1423</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.runInNewFrame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>1424</span> </span><span class="WHIT">    </span><span class="NAME">fn</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">opt_activate</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1425</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">newFrame</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Frame_</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1426</span> </span><span class="WHIT">      </span><span class="NAME">self</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1427</span> </span><span class="WHIT">      </span><span class="NAME">oldFrame</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.activeFrame_</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1428</span> 
<span class='line'>1429</span> </span><span class="WHIT">  </span><span class="KEYW">try</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1430</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.activeFrame_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1431</span> </span><span class="WHIT">      </span><span class="NAME">this.activeFrame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newFrame</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1432</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1433</span> </span><span class="WHIT">      </span><span class="NAME">this.activeFrame_.addChild</span><span class="PUNC">(</span><span class="NAME">newFrame</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1434</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1435</span> 
<span class='line'>1436</span> </span><span class="WHIT">    </span><span class="COMM">// Activate the new frame to force tasks to be treated as sub-tasks of</span><span class="WHIT">
<span class='line'>1437</span> </span><span class="WHIT">    </span><span class="COMM">// the parent frame.</span><span class="WHIT">
<span class='line'>1438</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">opt_activate</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1439</span> </span><span class="WHIT">      </span><span class="NAME">this.activeFrame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newFrame</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1440</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1441</span> 
<span class='line'>1442</span> </span><span class="WHIT">    </span><span class="KEYW">try</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1443</span> </span><span class="WHIT">      </span><span class="NAME">this.schedulingFrame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newFrame</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1444</span> </span><span class="WHIT">      </span><span class="NAME">webdriver.promise.pushFlow_</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1445</span> </span><span class="WHIT">      </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fn</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1446</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">finally</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1447</span> </span><span class="WHIT">      </span><span class="NAME">webdriver.promise.popFlow_</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1448</span> </span><span class="WHIT">      </span><span class="NAME">this.schedulingFrame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1449</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1450</span> </span><span class="WHIT">    </span><span class="NAME">newFrame.lockFrame</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1451</span> 
<span class='line'>1452</span> </span><span class="WHIT">    </span><span class="COMM">// If there was nothing scheduled in the new frame we can discard the</span><span class="WHIT">
<span class='line'>1453</span> </span><span class="WHIT">    </span><span class="COMM">// frame and return immediately.</span><span class="WHIT">
<span class='line'>1454</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">newFrame.children_.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1455</span> </span><span class="WHIT">      </span><span class="NAME">removeNewFrame</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1456</span> </span><span class="WHIT">      </span><span class="NAME">webdriver.promise.asap</span><span class="PUNC">(</span><span class="NAME">result</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1457</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1458</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1459</span> 
<span class='line'>1460</span> </span><span class="WHIT">    </span><span class="NAME">newFrame.then</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1461</span> </span><span class="WHIT">      </span><span class="NAME">webdriver.promise.asap</span><span class="PUNC">(</span><span class="NAME">result</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1462</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1463</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">result</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Promise</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">result.isPending</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1464</span> </span><span class="WHIT">        </span><span class="NAME">result.cancel</span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1465</span> </span><span class="WHIT">        </span><span class="NAME">e</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">result</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1466</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1467</span> </span><span class="WHIT">      </span><span class="NAME">errback</span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1468</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1469</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">catch</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ex</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1470</span> </span><span class="WHIT">    </span><span class="NAME">removeNewFrame</span><span class="PUNC">(</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.CanceledTaskError_</span><span class="PUNC">(</span><span class="NAME">ex</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1471</span> </span><span class="WHIT">    </span><span class="NAME">errback</span><span class="PUNC">(</span><span class="NAME">ex</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1472</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1473</span> 
<span class='line'>1474</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1475</span>    * @param {webdriver.promise.CanceledTaskError_=} opt_err If provided, the
<span class='line'>1476</span>    *     error that triggered the removal of this frame.
<span class='line'>1477</span>    */</span><span class="WHIT">
<span class='line'>1478</span> </span><span class="WHIT">  </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">removeNewFrame</span><span class="PUNC">(</span><span class="NAME">opt_err</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1479</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">parent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newFrame.getParent</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1480</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">parent</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1481</span> </span><span class="WHIT">      </span><span class="NAME">parent.removeChild</span><span class="PUNC">(</span><span class="NAME">newFrame</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1482</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1483</span> 
<span class='line'>1484</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">opt_err</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1485</span> </span><span class="WHIT">      </span><span class="NAME">newFrame.cancelRemainingTasks</span><span class="PUNC">(</span><span class="NAME">opt_err</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1486</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1487</span> </span><span class="WHIT">    </span><span class="NAME">self.activeFrame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">oldFrame</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1488</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1489</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1490</span> 
<span class='line'>1491</span> 
<span class='line'>1492</span> </span><span class="COMM">/**
<span class='line'>1493</span>  * Commences the shutdown sequence for this instance. After one turn of the
<span class='line'>1494</span>  * event loop, this object will emit the
<span class='line'>1495</span>  * {@link webdriver.promise.ControlFlow.EventType.IDLE} event to signal
<span class='line'>1496</span>  * listeners that it has completed. During this wait, if another task is
<span class='line'>1497</span>  * scheduled, the shutdown will be aborted.
<span class='line'>1498</span>  * @private
<span class='line'>1499</span>  */</span><span class="WHIT">
<span class='line'>1500</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.commenceShutdown_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1501</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.shutdownId_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1502</span> </span><span class="WHIT">    </span><span class="COMM">// Go ahead and stop the event loop now.  If we're in here, then there are</span><span class="WHIT">
<span class='line'>1503</span> </span><span class="WHIT">    </span><span class="COMM">// no more frames with tasks to execute. If we waited to cancel the event</span><span class="WHIT">
<span class='line'>1504</span> </span><span class="WHIT">    </span><span class="COMM">// loop in our timeout below, the event loop could trigger *before* the</span><span class="WHIT">
<span class='line'>1505</span> </span><span class="WHIT">    </span><span class="COMM">// timeout, generating an error from there being no frames.</span><span class="WHIT">
<span class='line'>1506</span> </span><span class="WHIT">    </span><span class="COMM">// If #execute is called before the timeout below fires, it will cancel</span><span class="WHIT">
<span class='line'>1507</span> </span><span class="WHIT">    </span><span class="COMM">// the timeout and restart the event loop.</span><span class="WHIT">
<span class='line'>1508</span> </span><span class="WHIT">    </span><span class="NAME">this.cancelEventLoop_</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1509</span> 
<span class='line'>1510</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">self</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1511</span> </span><span class="WHIT">    </span><span class="NAME">self.shutdownId_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">self.timer.setTimeout</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1512</span> </span><span class="WHIT">      </span><span class="NAME">self.shutdownId_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1513</span> </span><span class="WHIT">      </span><span class="NAME">self.emit</span><span class="PUNC">(</span><span class="NAME">webdriver.promise.ControlFlow.EventType.IDLE</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1514</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1515</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1516</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1517</span> 
<span class='line'>1518</span> 
<span class='line'>1519</span> </span><span class="COMM">/**
<span class='line'>1520</span>  * Cancels the shutdown sequence if it is currently scheduled.
<span class='line'>1521</span>  * @private
<span class='line'>1522</span>  */</span><span class="WHIT">
<span class='line'>1523</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.cancelShutdown_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1524</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.shutdownId_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1525</span> </span><span class="WHIT">    </span><span class="NAME">this.timer.clearTimeout</span><span class="PUNC">(</span><span class="NAME">this.shutdownId_</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1526</span> </span><span class="WHIT">    </span><span class="NAME">this.shutdownId_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1527</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1528</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1529</span> 
<span class='line'>1530</span> 
<span class='line'>1531</span> </span><span class="COMM">/**
<span class='line'>1532</span>  * Aborts this flow, abandoning all remaining tasks. If there are
<span class='line'>1533</span>  * listeners registered, an {@code UNCAUGHT_EXCEPTION} will be emitted with the
<span class='line'>1534</span>  * offending {@code error}, otherwise, the {@code error} will be rethrown to the
<span class='line'>1535</span>  * global error handler.
<span class='line'>1536</span>  * @param {*} error Object describing the error that caused the flow to
<span class='line'>1537</span>  *     abort; usually either an Error or string value.
<span class='line'>1538</span>  * @private
<span class='line'>1539</span>  */</span><span class="WHIT">
<span class='line'>1540</span> </span><span class="NAME">webdriver.promise.ControlFlow.prototype.abortNow_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1541</span> </span><span class="WHIT">  </span><span class="NAME">this.activeFrame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1542</span> </span><span class="WHIT">  </span><span class="NAME">this.cancelShutdown_</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1543</span> </span><span class="WHIT">  </span><span class="NAME">this.cancelEventLoop_</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1544</span> 
<span class='line'>1545</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">listeners</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.listeners</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>1546</span> </span><span class="WHIT">      </span><span class="NAME">webdriver.promise.ControlFlow.EventType.UNCAUGHT_EXCEPTION</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1547</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">listeners.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1548</span> </span><span class="WHIT">    </span><span class="NAME">this.timer.setTimeout</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1549</span> </span><span class="WHIT">      </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="NAME">error</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1550</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1551</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1552</span> </span><span class="WHIT">    </span><span class="NAME">this.emit</span><span class="PUNC">(</span><span class="NAME">webdriver.promise.ControlFlow.EventType.UNCAUGHT_EXCEPTION</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1553</span> </span><span class="WHIT">        </span><span class="NAME">error</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1554</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1555</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1556</span> 
<span class='line'>1557</span> 
<span class='line'>1558</span> 
<span class='line'>1559</span> </span><span class="COMM">/**
<span class='line'>1560</span>  * A single node in an {@link webdriver.promise.ControlFlow}'s task tree.
<span class='line'>1561</span>  * @param {!webdriver.promise.ControlFlow} flow The flow this instance belongs
<span class='line'>1562</span>  *     to.
<span class='line'>1563</span>  * @constructor
<span class='line'>1564</span>  * @extends {webdriver.promise.Deferred}
<span class='line'>1565</span>  * @private
<span class='line'>1566</span>  */</span><span class="WHIT">
<span class='line'>1567</span> </span><span class="NAME">webdriver.promise.Node_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">flow</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1568</span> </span><span class="WHIT">  </span><span class="NAME">webdriver.promise.Deferred.call</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">flow</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1569</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1570</span> </span><span class="NAME">goog.inherits</span><span class="PUNC">(</span><span class="NAME">webdriver.promise.Node_</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Deferred</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1571</span> 
<span class='line'>1572</span> 
<span class='line'>1573</span> </span><span class="COMM">/**
<span class='line'>1574</span>  * This node's parent.
<span class='line'>1575</span>  * @private {webdriver.promise.Node_}
<span class='line'>1576</span>  */</span><span class="WHIT">
<span class='line'>1577</span> </span><span class="NAME">webdriver.promise.Node_.prototype.parent_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1578</span> 
<span class='line'>1579</span> 
<span class='line'>1580</span> </span><span class="COMM">/** @return {webdriver.promise.Node_} This node's parent. */</span><span class="WHIT">
<span class='line'>1581</span> </span><span class="NAME">webdriver.promise.Node_.prototype.getParent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1582</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.parent_</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1583</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1584</span> 
<span class='line'>1585</span> 
<span class='line'>1586</span> </span><span class="COMM">/**
<span class='line'>1587</span>  * @param {webdriver.promise.Node_} parent This node's new parent.
<span class='line'>1588</span>  */</span><span class="WHIT">
<span class='line'>1589</span> </span><span class="NAME">webdriver.promise.Node_.prototype.setParent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">parent</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1590</span> </span><span class="WHIT">  </span><span class="NAME">this.parent_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parent</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1591</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1592</span> 
<span class='line'>1593</span> 
<span class='line'>1594</span> </span><span class="COMM">/**
<span class='line'>1595</span>  * @return {!webdriver.promise.Node_} The root of this node's tree.
<span class='line'>1596</span>  */</span><span class="WHIT">
<span class='line'>1597</span> </span><span class="NAME">webdriver.promise.Node_.prototype.getRoot</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1598</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">root</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1599</span> </span><span class="WHIT">  </span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">root.parent_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1600</span> </span><span class="WHIT">    </span><span class="NAME">root</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">root.parent_</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1601</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1602</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">root</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1603</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1604</span> 
<span class='line'>1605</span> 
<span class='line'>1606</span> 
<span class='line'>1607</span> </span><span class="COMM">/**
<span class='line'>1608</span>  * An execution frame within a {@link webdriver.promise.ControlFlow}.  Each
<span class='line'>1609</span>  * frame represents the execution context for either a
<span class='line'>1610</span>  * {@link webdriver.promise.Task_} or a callback on a
<span class='line'>1611</span>  * {@link webdriver.promise.Deferred}.
<span class='line'>1612</span>  *
<span class='line'>1613</span>  * &lt;p>Each frame may contain sub-frames.  If child N is a sub-frame, then the
<span class='line'>1614</span>  * items queued within it are given priority over child N+1.
<span class='line'>1615</span>  *
<span class='line'>1616</span>  * @param {!webdriver.promise.ControlFlow} flow The flow this instance belongs
<span class='line'>1617</span>  *     to.
<span class='line'>1618</span>  * @constructor
<span class='line'>1619</span>  * @extends {webdriver.promise.Node_}
<span class='line'>1620</span>  * @private
<span class='line'>1621</span>  */</span><span class="WHIT">
<span class='line'>1622</span> </span><span class="NAME">webdriver.promise.Frame_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">flow</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1623</span> </span><span class="WHIT">  </span><span class="NAME">webdriver.promise.Node_.call</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">flow</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1624</span> 
<span class='line'>1625</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">reject</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">goog.bind</span><span class="PUNC">(</span><span class="NAME">this.reject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1626</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cancelRemainingTasks</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">goog.bind</span><span class="PUNC">(</span><span class="NAME">this.cancelRemainingTasks</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1627</span> 
<span class='line'>1628</span> </span><span class="WHIT">  </span><span class="COMM">/** @override */</span><span class="WHIT">
<span class='line'>1629</span> </span><span class="WHIT">  </span><span class="NAME">this.reject</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1630</span> </span><span class="WHIT">    </span><span class="NAME">cancelRemainingTasks</span><span class="PUNC">(</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.CanceledTaskError_</span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1631</span> </span><span class="WHIT">    </span><span class="NAME">reject</span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1632</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1633</span> 
<span class='line'>1634</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1635</span>    * @private {!Array.&lt;!(webdriver.promise.Frame_|webdriver.promise.Task_)>}
<span class='line'>1636</span>    */</span><span class="WHIT">
<span class='line'>1637</span> </span><span class="WHIT">  </span><span class="NAME">this.children_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1638</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1639</span> </span><span class="NAME">goog.inherits</span><span class="PUNC">(</span><span class="NAME">webdriver.promise.Frame_</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Node_</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1640</span> 
<span class='line'>1641</span> 
<span class='line'>1642</span> </span><span class="COMM">/**
<span class='line'>1643</span>  * The task currently being executed within this frame.
<span class='line'>1644</span>  * @private {webdriver.promise.Task_}
<span class='line'>1645</span>  */</span><span class="WHIT">
<span class='line'>1646</span> </span><span class="NAME">webdriver.promise.Frame_.prototype.pendingTask_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1647</span> 
<span class='line'>1648</span> 
<span class='line'>1649</span> </span><span class="COMM">/**
<span class='line'>1650</span>  * Whether this frame is active. A frame is considered active once one of its
<span class='line'>1651</span>  * descendants has been removed for execution.
<span class='line'>1652</span>  *
<span class='line'>1653</span>  * Adding a sub-frame as a child to an active frame is an indication that
<span class='line'>1654</span>  * a callback to a {@link webdriver.promise.Deferred} is being invoked and any
<span class='line'>1655</span>  * tasks scheduled within it should have priority over previously scheduled
<span class='line'>1656</span>  * tasks:
<span class='line'>1657</span>  * &lt;code>&lt;pre>
<span class='line'>1658</span>  *   var flow = webdriver.promise.controlFlow();
<span class='line'>1659</span>  *   flow.execute('start here', goog.nullFunction).then(function() {
<span class='line'>1660</span>  *     flow.execute('this should execute 2nd', goog.nullFunction);
<span class='line'>1661</span>  *   });
<span class='line'>1662</span>  *   flow.execute('this should execute last', goog.nullFunction);
<span class='line'>1663</span>  * &lt;/pre>&lt;/code>
<span class='line'>1664</span>  *
<span class='line'>1665</span>  * @private {boolean}
<span class='line'>1666</span>  */</span><span class="WHIT">
<span class='line'>1667</span> </span><span class="NAME">webdriver.promise.Frame_.prototype.isActive_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1668</span> 
<span class='line'>1669</span> 
<span class='line'>1670</span> </span><span class="COMM">/**
<span class='line'>1671</span>  * Whether this frame is currently locked. A locked frame represents a callback
<span class='line'>1672</span>  * or task function which has run to completion and scheduled all of its tasks.
<span class='line'>1673</span>  *
<span class='line'>1674</span>  * &lt;p>Once a frame becomes {@link #isActive_ active}, any new frames which are
<span class='line'>1675</span>  * added represent callbacks on a {@link webdriver.promise.Deferred}, whose
<span class='line'>1676</span>  * tasks must be given priority over previously scheduled tasks.
<span class='line'>1677</span>  *
<span class='line'>1678</span>  * @private {boolean}
<span class='line'>1679</span>  */</span><span class="WHIT">
<span class='line'>1680</span> </span><span class="NAME">webdriver.promise.Frame_.prototype.isLocked_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1681</span> 
<span class='line'>1682</span> 
<span class='line'>1683</span> </span><span class="COMM">/**
<span class='line'>1684</span>  * A reference to the last node inserted in this frame.
<span class='line'>1685</span>  * @private {webdriver.promise.Node_}
<span class='line'>1686</span>  */</span><span class="WHIT">
<span class='line'>1687</span> </span><span class="NAME">webdriver.promise.Frame_.prototype.lastInsertedChild_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1688</span> 
<span class='line'>1689</span> 
<span class='line'>1690</span> </span><span class="COMM">/**
<span class='line'>1691</span>  * Marks all of the tasks that are descendants of this frame in the execution
<span class='line'>1692</span>  * tree as cancelled. This is necessary for callbacks scheduled asynchronous.
<span class='line'>1693</span>  * For example:
<span class='line'>1694</span>  *
<span class='line'>1695</span>  *     var someResult;
<span class='line'>1696</span>  *     webdriver.promise.createFlow(function(flow) {
<span class='line'>1697</span>  *       someResult = flow.execute(function() {});
<span class='line'>1698</span>  *       throw Error();
<span class='line'>1699</span>  *     }).addErrback(function(err) {
<span class='line'>1700</span>  *       console.log('flow failed: ' + err);
<span class='line'>1701</span>  *       someResult.then(function() {
<span class='line'>1702</span>  *         console.log('task succeeded!');
<span class='line'>1703</span>  *       }, function(err) {
<span class='line'>1704</span>  *         console.log('task failed! ' + err);
<span class='line'>1705</span>  *       });
<span class='line'>1706</span>  *     });
<span class='line'>1707</span>  *     // flow failed: Error: boom
<span class='line'>1708</span>  *     // task failed! CanceledTaskError: Task discarded due to a previous
<span class='line'>1709</span>  *     // task failure: Error: boom
<span class='line'>1710</span>  *
<span class='line'>1711</span>  * @param {!webdriver.promise.CanceledTaskError_} error The cancellation
<span class='line'>1712</span>  *     error.
<span class='line'>1713</span>  */</span><span class="WHIT">
<span class='line'>1714</span> </span><span class="NAME">webdriver.promise.Frame_.prototype.cancelRemainingTasks</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1715</span> </span><span class="WHIT">  </span><span class="NAME">goog.array.forEach</span><span class="PUNC">(</span><span class="NAME">this.children_</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">child</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1716</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">child</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Frame_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1717</span> </span><span class="WHIT">      </span><span class="NAME">child.cancelRemainingTasks</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1718</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1719</span> </span><span class="WHIT">      </span><span class="COMM">// None of the previously registered listeners should be notified that</span><span class="WHIT">
<span class='line'>1720</span> </span><span class="WHIT">      </span><span class="COMM">// the task is being canceled, however, we need at least one errback</span><span class="WHIT">
<span class='line'>1721</span> </span><span class="WHIT">      </span><span class="COMM">// to prevent the cancellation from bubbling up.</span><span class="WHIT">
<span class='line'>1722</span> </span><span class="WHIT">      </span><span class="NAME">child.removeAll</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1723</span> </span><span class="WHIT">      </span><span class="NAME">child.addErrback</span><span class="PUNC">(</span><span class="NAME">goog.nullFunction</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1724</span> </span><span class="WHIT">      </span><span class="NAME">child.cancel</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1725</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1726</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1727</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1728</span> 
<span class='line'>1729</span> 
<span class='line'>1730</span> </span><span class="COMM">/**
<span class='line'>1731</span>  * @return {webdriver.promise.Task_} The task currently executing
<span class='line'>1732</span>  *     within this frame, if any.
<span class='line'>1733</span>  */</span><span class="WHIT">
<span class='line'>1734</span> </span><span class="NAME">webdriver.promise.Frame_.prototype.getPendingTask</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1735</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.pendingTask_</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1736</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1737</span> 
<span class='line'>1738</span> 
<span class='line'>1739</span> </span><span class="COMM">/**
<span class='line'>1740</span>  * @param {webdriver.promise.Task_} task The task currently
<span class='line'>1741</span>  *     executing within this frame, if any.
<span class='line'>1742</span>  */</span><span class="WHIT">
<span class='line'>1743</span> </span><span class="NAME">webdriver.promise.Frame_.prototype.setPendingTask</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">task</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1744</span> </span><span class="WHIT">  </span><span class="NAME">this.pendingTask_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">task</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1745</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1746</span> 
<span class='line'>1747</span> 
<span class='line'>1748</span> </span><span class="COMM">/** Locks this frame. */</span><span class="WHIT">
<span class='line'>1749</span> </span><span class="NAME">webdriver.promise.Frame_.prototype.lockFrame</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1750</span> </span><span class="WHIT">  </span><span class="NAME">this.isLocked_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1751</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1752</span> 
<span class='line'>1753</span> 
<span class='line'>1754</span> </span><span class="COMM">/**
<span class='line'>1755</span>  * Adds a new node to this frame.
<span class='line'>1756</span>  * @param {!(webdriver.promise.Frame_|webdriver.promise.Task_)} node
<span class='line'>1757</span>  *     The node to insert.
<span class='line'>1758</span>  */</span><span class="WHIT">
<span class='line'>1759</span> </span><span class="NAME">webdriver.promise.Frame_.prototype.addChild</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1760</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.lastInsertedChild_</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>1761</span> </span><span class="WHIT">      </span><span class="NAME">this.lastInsertedChild_</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Frame_</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>1762</span> </span><span class="WHIT">      </span><span class="PUNC">!</span><span class="NAME">this.lastInsertedChild_.isLocked_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1763</span> </span><span class="WHIT">    </span><span class="NAME">this.lastInsertedChild_.addChild</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1764</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1765</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1766</span> 
<span class='line'>1767</span> </span><span class="WHIT">  </span><span class="NAME">node.setParent</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1768</span> 
<span class='line'>1769</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.isActive_</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">node</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Frame_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1770</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">index</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1771</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.lastInsertedChild_</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT">
<span class='line'>1772</span> </span><span class="WHIT">        </span><span class="NAME">webdriver.promise.Frame_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1773</span> </span><span class="WHIT">      </span><span class="NAME">index</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">goog.array.indexOf</span><span class="PUNC">(</span><span class="NAME">this.children_</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.lastInsertedChild_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1774</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1775</span> </span><span class="WHIT">    </span><span class="NAME">goog.array.insertAt</span><span class="PUNC">(</span><span class="NAME">this.children_</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">index</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1776</span> </span><span class="WHIT">    </span><span class="NAME">this.lastInsertedChild_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">node</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1777</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1778</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1779</span> 
<span class='line'>1780</span> </span><span class="WHIT">  </span><span class="NAME">this.lastInsertedChild_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">node</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1781</span> </span><span class="WHIT">  </span><span class="NAME">this.children_.push</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1782</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1783</span> 
<span class='line'>1784</span> 
<span class='line'>1785</span> </span><span class="COMM">/**
<span class='line'>1786</span>  * @return {(webdriver.promise.Frame_|webdriver.promise.Task_)} This frame's
<span class='line'>1787</span>  *     fist child.
<span class='line'>1788</span>  */</span><span class="WHIT">
<span class='line'>1789</span> </span><span class="NAME">webdriver.promise.Frame_.prototype.getFirstChild</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1790</span> </span><span class="WHIT">  </span><span class="NAME">this.isActive_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1791</span> </span><span class="WHIT">  </span><span class="NAME">this.lastInsertedChild_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1792</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.children_</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1793</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1794</span> 
<span class='line'>1795</span> 
<span class='line'>1796</span> </span><span class="COMM">/**
<span class='line'>1797</span>  * Removes a child from this frame.
<span class='line'>1798</span>  * @param {!(webdriver.promise.Frame_|webdriver.promise.Task_)} child
<span class='line'>1799</span>  *     The child to remove.
<span class='line'>1800</span>  */</span><span class="WHIT">
<span class='line'>1801</span> </span><span class="NAME">webdriver.promise.Frame_.prototype.removeChild</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">child</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1802</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">index</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">goog.array.indexOf</span><span class="PUNC">(</span><span class="NAME">this.children_</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">child</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1803</span> </span><span class="WHIT">  </span><span class="NAME">child.setParent</span><span class="PUNC">(</span><span class="KEYW">null</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1804</span> </span><span class="WHIT">  </span><span class="NAME">goog.array.removeAt</span><span class="PUNC">(</span><span class="NAME">this.children_</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">index</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1805</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.lastInsertedChild_</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">child</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1806</span> </span><span class="WHIT">    </span><span class="NAME">this.lastInsertedChild_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1807</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1808</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1809</span> 
<span class='line'>1810</span> 
<span class='line'>1811</span> </span><span class="COMM">/** @override */</span><span class="WHIT">
<span class='line'>1812</span> </span><span class="NAME">webdriver.promise.Frame_.prototype.toString</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1813</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">'['</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">goog.array.map</span><span class="PUNC">(</span><span class="NAME">this.children_</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">child</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1814</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">child.toString</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1815</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">join</span><span class="PUNC">(</span><span class="STRN">', '</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">']'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1816</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1817</span> 
<span class='line'>1818</span> 
<span class='line'>1819</span> 
<span class='line'>1820</span> </span><span class="COMM">/**
<span class='line'>1821</span>  * A task to be executed by a {@link webdriver.promise.ControlFlow}.
<span class='line'>1822</span>  *
<span class='line'>1823</span>  * @param {!webdriver.promise.ControlFlow} flow The flow this instances belongs
<span class='line'>1824</span>  *     to.
<span class='line'>1825</span>  * @param {!Function} fn The function to call when the task executes. If it
<span class='line'>1826</span>  *     returns a {@code webdriver.promise.Promise}, the flow will wait
<span class='line'>1827</span>  *     for it to be resolved before starting the next task.
<span class='line'>1828</span>  * @param {string} description A description of the task for debugging.
<span class='line'>1829</span>  * @param {!webdriver.stacktrace.Snapshot} snapshot A snapshot of the stack
<span class='line'>1830</span>  *     when this task was scheduled.
<span class='line'>1831</span>  * @constructor
<span class='line'>1832</span>  * @extends {webdriver.promise.Node_}
<span class='line'>1833</span>  * @private
<span class='line'>1834</span>  */</span><span class="WHIT">
<span class='line'>1835</span> </span><span class="NAME">webdriver.promise.Task_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">flow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">fn</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">description</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">snapshot</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1836</span> </span><span class="WHIT">  </span><span class="NAME">webdriver.promise.Node_.call</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">flow</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1837</span> 
<span class='line'>1838</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1839</span>    * Executes this task.
<span class='line'>1840</span>    * @type {!Function}
<span class='line'>1841</span>    */</span><span class="WHIT">
<span class='line'>1842</span> </span><span class="WHIT">  </span><span class="NAME">this.execute</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fn</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1843</span> 
<span class='line'>1844</span> </span><span class="WHIT">  </span><span class="COMM">/** @private {string} */</span><span class="WHIT">
<span class='line'>1845</span> </span><span class="WHIT">  </span><span class="NAME">this.description_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">description</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1846</span> 
<span class='line'>1847</span> </span><span class="WHIT">  </span><span class="COMM">/** @private {!webdriver.stacktrace.Snapshot} */</span><span class="WHIT">
<span class='line'>1848</span> </span><span class="WHIT">  </span><span class="NAME">this.snapshot_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">snapshot</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1849</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1850</span> </span><span class="NAME">goog.inherits</span><span class="PUNC">(</span><span class="NAME">webdriver.promise.Task_</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.Node_</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1851</span> 
<span class='line'>1852</span> 
<span class='line'>1853</span> </span><span class="COMM">/** @return {string} This task's description. */</span><span class="WHIT">
<span class='line'>1854</span> </span><span class="NAME">webdriver.promise.Task_.prototype.getDescription</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1855</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.description_</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1856</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1857</span> 
<span class='line'>1858</span> 
<span class='line'>1859</span> </span><span class="COMM">/** @override */</span><span class="WHIT">
<span class='line'>1860</span> </span><span class="NAME">webdriver.promise.Task_.prototype.toString</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1861</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">stack</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.snapshot_.getStacktrace</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1862</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.description_</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1863</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">stack.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1864</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.description_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1865</span> </span><span class="WHIT">      </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'\n'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1866</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1867</span> </span><span class="WHIT">    </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">stack.join</span><span class="PUNC">(</span><span class="STRN">'\n'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1868</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1869</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1870</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1871</span> 
<span class='line'>1872</span> 
<span class='line'>1873</span> 
<span class='line'>1874</span> </span><span class="COMM">/**
<span class='line'>1875</span>  * Special error used to signal when a task is canceled because a previous
<span class='line'>1876</span>  * task in the same frame failed.
<span class='line'>1877</span>  * @param {*} err The error that caused the task cancellation.
<span class='line'>1878</span>  * @constructor
<span class='line'>1879</span>  * @extends {goog.debug.Error}
<span class='line'>1880</span>  * @private
<span class='line'>1881</span>  */</span><span class="WHIT">
<span class='line'>1882</span> </span><span class="NAME">webdriver.promise.CanceledTaskError_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">err</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1883</span> </span><span class="WHIT">  </span><span class="NAME">goog.base</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'Task discarded due to a previous task failure: '</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">err</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1884</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1885</span> </span><span class="NAME">goog.inherits</span><span class="PUNC">(</span><span class="NAME">webdriver.promise.CanceledTaskError_</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">goog.debug.Error</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1886</span> 
<span class='line'>1887</span> 
<span class='line'>1888</span> </span><span class="COMM">/** @override */</span><span class="WHIT">
<span class='line'>1889</span> </span><span class="NAME">webdriver.promise.CanceledTaskError_.prototype.name</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'CanceledTaskError'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1890</span> 
<span class='line'>1891</span> 
<span class='line'>1892</span> 
<span class='line'>1893</span> </span><span class="COMM">/**
<span class='line'>1894</span>  * The default flow to use if no others are active.
<span class='line'>1895</span>  * @private {!webdriver.promise.ControlFlow}
<span class='line'>1896</span>  */</span><span class="WHIT">
<span class='line'>1897</span> </span><span class="NAME">webdriver.promise.defaultFlow_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.ControlFlow</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1898</span> 
<span class='line'>1899</span> 
<span class='line'>1900</span> </span><span class="COMM">/**
<span class='line'>1901</span>  * A stack of active control flows, with the top of the stack used to schedule
<span class='line'>1902</span>  * commands. When there are multiple flows on the stack, the flow at index N
<span class='line'>1903</span>  * represents a callback triggered within a task owned by the flow at index
<span class='line'>1904</span>  * N-1.
<span class='line'>1905</span>  * @private {!Array.&lt;!webdriver.promise.ControlFlow>}
<span class='line'>1906</span>  */</span><span class="WHIT">
<span class='line'>1907</span> </span><span class="NAME">webdriver.promise.activeFlows_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1908</span> 
<span class='line'>1909</span> 
<span class='line'>1910</span> </span><span class="COMM">/**
<span class='line'>1911</span>  * Changes the default flow to use when no others are active.
<span class='line'>1912</span>  * @param {!webdriver.promise.ControlFlow} flow The new default flow.
<span class='line'>1913</span>  * @throws {Error} If the default flow is not currently active.
<span class='line'>1914</span>  */</span><span class="WHIT">
<span class='line'>1915</span> </span><span class="NAME">webdriver.promise.setDefaultFlow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">flow</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1916</span> </span><span class="WHIT">  </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">webdriver.promise.activeFlows_.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1917</span> </span><span class="WHIT">    </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">'You may only change the default flow while it is active'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1918</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1919</span> </span><span class="WHIT">  </span><span class="NAME">webdriver.promise.defaultFlow_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">flow</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1920</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1921</span> 
<span class='line'>1922</span> 
<span class='line'>1923</span> </span><span class="COMM">/**
<span class='line'>1924</span>  * @return {!webdriver.promise.ControlFlow} The currently active control flow.
<span class='line'>1925</span>  */</span><span class="WHIT">
<span class='line'>1926</span> </span><span class="NAME">webdriver.promise.controlFlow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1927</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="COMM">/** @type {!webdriver.promise.ControlFlow} */</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>1928</span> </span><span class="WHIT">      </span><span class="NAME">goog.array.peek</span><span class="PUNC">(</span><span class="NAME">webdriver.promise.activeFlows_</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class='line'>1929</span> </span><span class="WHIT">      </span><span class="NAME">webdriver.promise.defaultFlow_</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1930</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1931</span> 
<span class='line'>1932</span> 
<span class='line'>1933</span> </span><span class="COMM">/**
<span class='line'>1934</span>  * @param {!webdriver.promise.ControlFlow} flow The new flow.
<span class='line'>1935</span>  * @private
<span class='line'>1936</span>  */</span><span class="WHIT">
<span class='line'>1937</span> </span><span class="NAME">webdriver.promise.pushFlow_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">flow</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1938</span> </span><span class="WHIT">  </span><span class="NAME">webdriver.promise.activeFlows_.push</span><span class="PUNC">(</span><span class="NAME">flow</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1939</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1940</span> 
<span class='line'>1941</span> 
<span class='line'>1942</span> </span><span class="COMM">/** @private */</span><span class="WHIT">
<span class='line'>1943</span> </span><span class="NAME">webdriver.promise.popFlow_</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1944</span> </span><span class="WHIT">  </span><span class="NAME">webdriver.promise.activeFlows_.pop</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1945</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1946</span> 
<span class='line'>1947</span> 
<span class='line'>1948</span> </span><span class="COMM">/**
<span class='line'>1949</span>  * Creates a new control flow. The provided callback will be invoked as the
<span class='line'>1950</span>  * first task within the new flow, with the flow as its sole argument. Returns
<span class='line'>1951</span>  * a promise that resolves to the callback result.
<span class='line'>1952</span>  * @param {function(!webdriver.promise.ControlFlow)} callback The entry point
<span class='line'>1953</span>  *     to the newly created flow.
<span class='line'>1954</span>  * @return {!webdriver.promise.Promise} A promise that resolves to the callback
<span class='line'>1955</span>  *     result.
<span class='line'>1956</span>  */</span><span class="WHIT">
<span class='line'>1957</span> </span><span class="NAME">webdriver.promise.createFlow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1958</span> </span><span class="WHIT">  </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">flow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">webdriver.promise.ControlFlow</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>1959</span> </span><span class="WHIT">      </span><span class="NAME">webdriver.promise.defaultFlow_.timer</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1960</span> </span><span class="WHIT">  </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">flow.execute</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1961</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">(</span><span class="NAME">flow</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1962</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1963</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1964</span> </span></pre></body></html>